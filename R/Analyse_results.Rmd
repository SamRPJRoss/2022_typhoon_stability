---
title: "Analysis and Figures"
author: "Samuel R.P-J. Ross"
date: '2022-07-08'
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## Packages:
library(nlme)
library(patchwork)
library(here)
library(brms)
library(tidybayes)
library(cowplot)
library(ape)
library(dplyr)
library(ggplot2)
library(tibble)
library(tidyr)
library(readr)
library(purrr)
library(stringr)
library(forcats)
#library(simpleboot)
library(segmented)

# get data
load(here("Data/Stability_Acoustic_Indices.rda"))
load(here("Data/Stability_Species_Detections.rda"))

# get site names ordered by land use PC1 for later use in figures
load(here("Data/all_landuse.rda"))
Site_order<-Landuse_1000$site_id[order(Landuse_1000$PC1)]
rm(Landuse_1000)
```

This markdown is for building models to test effects of land use and typhoons on acoustic indices and bird species detections. Modeling framework uses Bayesian models to test for effects of typhoons and land use (plus their interaction) on means and variabilities of acoustic indices and bird detections. Also tests land use effect on acoustic index resistance and recovery. Can test for spatial autocorrelation of model residuals and fit spatial error terms where needed.

### Acoustic indices

## acoustic index mean states

**NDSI - negative change after typhoon**

```{r}
# get pre vs post data for comparison
dat_pre<-tidy.stability_AI %>%
  filter(Index %in% "NDSI" & response_variable %in% 'Pre_mean') 
dat_post<-tidy.stability_AI %>%
  filter(Index %in% "NDSI" & response_variable %in% 'Post_mean')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
#names(df)[1] <- names(Landuse_1000)[1]
#df <- left_join(df, Landuse_1000, by = "site_id")

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse * Typhoon + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## Parameter fits and stats 
mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

summary(mod_nonspatial_beta)

```

plot results:

```{r}

mut_mod<-mod_nonspatial_beta %>%
  spread_draws(b_TyphoonPost, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_TyphoonPost + r_Site_ID) # get posterior distribution data for plotting

# determine whether credible intervals span zero, and store as binary (to show in plot): 
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
}
rm(temp)
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor

# plot posterior typhoon effect
mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","skyblue")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (typhoon effect)",
       y = "Site") + 
  cowplot::theme_minimal_grid(font_size = 14,
                              colour = "grey92")

```

**NDSI_Bio - no effect of typhoon or land use**

```{r}
# get pre vs post data for comparison
dat_pre<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Bio" & response_variable %in% 'Pre_mean') 
dat_post<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Bio" & response_variable %in% 'Post_mean')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
#names(df)[1] <- names(Landuse_1000)[1]
#df <- left_join(df, Landuse_1000, by = "site_id")

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse * Typhoon + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

summary(mod_nonspatial_beta)

```

**NDSI_Anthro - positive change after typhoon**

```{r}
# get pre vs post data for comparison
dat_pre<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Anth" & response_variable %in% 'Pre_mean') 
dat_post<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Anth" & response_variable %in% 'Post_mean')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
#names(df)[1] <- names(Landuse_1000)[1]
#df <- left_join(df, Landuse_1000, by = "site_id")

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse * Typhoon + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## Parameter fits and stats 
mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

Plot typhoon effect: 

```{r}
mut_mod<-mod_nonspatial_beta %>%
  spread_draws(b_TyphoonPost, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_TyphoonPost + r_Site_ID) # get posterior distribution data for plotting

# determine whether credible intervals span zero, and store as binary (to show in plot): 
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
}
rm(temp)
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor

# plot posterior typhoon effect
mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","skyblue")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (typhoon effect)",
       y = "Site") + 
  cowplot::theme_minimal_grid(font_size = 14,
                              colour = "grey92")
```

## acoustic index temporal variability

**NDSI - no effect of typhoon or land use**

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.stability_AI %>%
  filter(Index %in% "NDSI" & response_variable %in% 'Pre_Var') 
dat_post<-tidy.stability_AI %>%
  filter(Index %in% "NDSI" & response_variable %in% 'Post_Var')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
#names(df)[1] <- names(Landuse_1000)[1]
#df <- left_join(df, Landuse_1000, by = "site_id")

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

# fit random intercept and slope model because random slope model didn't converge well.
mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse * Typhoon + (1+Landuse*Typhoon|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 
mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation
```

**NDSI_Bio - no effect of typhoon or land use**

```{r}
# get pre vs post data for comparison
dat_pre<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Bio" & response_variable %in% 'Pre_Var') 
dat_post<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Bio" & response_variable %in% 'Post_Var')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
#names(df)[1] <- names(Landuse_1000)[1]
#df <- left_join(df, Landuse_1000, by = "site_id")

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

# fit random intercept and slope model because random slope model didn't converge well.
mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse * Typhoon + (1+Landuse*Typhoon|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 
mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation
```

**NDSI_Anthro - no effect of typhoon or land use**

```{r}
# get pre vs post data for comparison
dat_pre<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Anth" & response_variable %in% 'Pre_Var') 
dat_post<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Anth" & response_variable %in% 'Post_Var')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
#names(df)[1] <- names(Landuse_1000)[1]
#df <- left_join(df, Landuse_1000, by = "site_id")

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

# fit random intercept and slope model because random slope model didn't converge well.
mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse * Typhoon + (1+Landuse*Typhoon|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

## acoustic index resistance

**NDSI - no effect of land use**

```{r}
# get pre vs post data for comparison
df<-tidy.stability_AI %>%
  filter(Index %in% "NDSI" & response_variable %in% 'Resist') 
df<-df[complete.cases(df),]

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 
mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

**NDSI_Bio - no effect of land use**

```{r}
# get pre vs post data for comparison
df<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Bio" & response_variable %in% 'Resist') 
df<-df[complete.cases(df),]

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 
mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

**NDSI_Anthro - no effect of land use**

```{r}
# get pre vs post data for comparison
df<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Anth" & response_variable %in% 'Resist') 
df<-df[complete.cases(df),]

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 
mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

## acoustic index recovery time

**NDSI - no effect of land use**

```{r}
# get pre vs post data for comparison
df<-tidy.stability_AI %>%
  filter(Index %in% "NDSI" & response_variable %in% 'Recov') 
df<-df[complete.cases(df),]

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 
mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

**NDSI_Bio - no effect of land use**

```{r}
# get pre vs post data for comparison
df<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Bio" & response_variable %in% 'Recov') 
df<-df[complete.cases(df),]

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 
mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation
```

**NDSI_Anthro - no effect of land use**

```{r}
# get pre vs post data for comparison
df<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Anth" & response_variable %in% 'Recov') 
df<-df[complete.cases(df),]

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

# fit random intercept and slope model because random slope model didn't converge well.
mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse + (1+Landuse|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 
mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation
```

## acoustic index spatial variability

Not using same Bayesian models for spatial variability here. Instead, using break-point models to see if spatial variability changes after typhoons, and whether values and value change differ by land use. NB: set break-points manually before and after typhoons, as this is *a priori* expectation for break point locations (then compare model performance against linear model without breaks).

**NDSI - typhoon x landuse interaction**

```{r}
# prepare data
df<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI" & response_group %in% 'Total_var') # get pre vs post data for comparison
df2<-df
df2$Date_Time<-df2$Date_Time %>%  julian.Date() %>% as.numeric() # convert to numeric date format for model
df2$Date_Time<-df2$Date_Time - min(df2$Date_Time) # scale date to start at zero for model

#hist(df$Stability) # looks Gaussian
olm<-lm(Stability ~ 0 + Date_Time,data = df2) # linear model
summary(olm)
#plot(olm)

## break-point model ##
os <- segmented(olm, 
                seg.Z = ~ Date_Time, # which variables to break
                psi = c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(), # break at Trami
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric()), # break after typhoons
                control = seg.control(it.max = 0)) # it.max = 0 prevents bootstrap procedure (i.e. forces manual break-point)

AIC(os,olm) # break point model performs better

## davies test of the change in slope after break points
davies.test(olm,values = c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(), # break at Trami
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric())) # break after typhoons
summary(os)

# get dates of manual breakpoint
Psi_1<-df$Date_Time[df$Period %in% 'Trami'][1]
Psi_2<-df$Date_Time[df$Period %in% 'Post-typhoon'][1]

# compare pre- and post-break acoustic index values
Break_results<-df %>% 
  filter(Period %in% c('Pre-typhoon','Post-typhoon')) %>% 
  group_by(Period) %>% 
  summarise(Med=median(Stability),
            Lo_95=quantile(Stability,probs = 0.05),
            Up_95=quantile(Stability,probs = 0.95))
Break_results$Period<-Break_results$Period %>% as.character() %>% parse_factor(levels = c('Pre-typhoon','Post-typhoon'))
```

Plot results:

```{r}
plot1<-df %>% ggplot(aes(x = Date_Time,
                  y = Stability)) +
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Trami'][1],lty = 2) + 
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Post-typhoon'][1],lty = 2) + 
  geom_line(show.legend = F) + 
  labs(x = "Time",
       y = "NDSI spatial variability") + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max())) 

plot2<-Break_results %>% ggplot(aes(x = Period,
                  y = Med,
                  ymin = Lo_95,
                  ymax = Up_95,
                  shape = Period)) +
  geom_pointrange(fatten = 5,
                  show.legend = F) + 
  labs(x = "Time period",
       y = element_blank()) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

panel_a<-plot1 + plot2 + plot_layout(widths = c(3,1))
panel_a
```

Now check for landuse effect:

```{r}
# prepare data
df<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI" & response_group %in% c('Forest_Var','Developed_Var')) # get pre vs post data for comparison
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
colnames(df)[4]<-'Landuse'
df$Landuse<-df$Landuse %>% as.character() %>% parse_factor(levels = c('Forest','Developed')) # change levels for model
df2<-df
df2$Date_Time<-df2$Date_Time %>%  julian.Date() %>% as.numeric() # convert to numeric date format for model
df2$Date_Time<-df2$Date_Time - min(df2$Date_Time) # scale date to start at zero for model

# split out time series for each land use class separately
temp<-model.matrix(~ 0 + df2$Landuse)*df2$Date_Time
date_for<-temp[,1]
date_dev<-temp[,2]
rm(temp)

#hist(df$Stability) # looks Gaussian
olm<-lm(Stability ~ 0 + Landuse + date_for + date_dev,data = df2) # linear model

## break-point model ##
os <- segmented(olm, 
                seg.Z = ~ date_for + date_dev, # which variables to break
                psi = list(date_for=c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(), # break at Trami
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric()), # break after typhoons
                  date_dev=c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(), # break at Trami
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric())), # break after typhoons
                control = seg.control(it.max = 0)) # it.max = 0 prevents bootstrap procedure (i.e. forces manual break-point)

AIC(os,olm) # break point model performs better

## davies test of the change in slope after break points
davies.test(olm,seg.Z = ~ date_for,
            values = c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(),
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric())) # test for change in slope of forest sites
davies.test(olm,seg.Z = ~ date_dev,
            values = c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(),
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric())) # test for change in slope of developed sites
summary(os)


# get dates of manual breakpoint
Psi_1<-df$Date_Time[df$Period %in% 'Trami'][1]
Psi_2<-df$Date_Time[df$Period %in% 'Post-typhoon'][1]

# compare pre- and post-break acoustic index values
Break_results<-df %>% 
  filter(Period %in% c('Pre-typhoon','Post-typhoon')) %>% 
  group_by(Landuse,Period) %>% 
  summarise(Med=median(Stability),
            Lo_95=quantile(Stability,probs = 0.05),
            Up_95=quantile(Stability,probs = 0.95))
Break_results$Period<-Break_results$Period %>% as.character() %>% parse_factor(levels = c('Pre-typhoon','Post-typhoon'))
Break_results$Landuse<-Break_results$Landuse %>% as.character() %>% parse_factor(levels = c('Forest','Developed'))
```

Plot results:

```{r}
plot1<-df %>% ggplot(aes(x = Date_Time,
                  y = Stability,
                  col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Trami'][1],lty = 2) + 
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Post-typhoon'][1],lty = 2) + 
  geom_line(show.legend = F) + 
  labs(x = "Time",
       y = "NDSI spatial variability") + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max())) 

plot2<-Break_results %>% ggplot(aes(x = Landuse,
                  y = Med,
                  ymin = Lo_95,
                  ymax = Up_95,
                  col = Landuse,
                  shape = Period)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_pointrange(position = position_jitterdodge(),
                  fatten = 5,
                  show.legend = F) + 
  labs(x = "Landuse",
       y = element_blank()) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

panel_b<-plot1 + plot2 + plot_layout(widths = c(3,1))
panel_b
```

```{r}
panel_a / panel_b
```

For axis legend: "dashed lines delineate the pre- and post-typhoon periods."

**NDSI_Bio - Landuse x typhoon effect**

```{r}
# prepare data
df<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Bio" & response_group %in% 'Total_var') # get pre vs post data for comparison
df2<-df
df2$Date_Time<-df2$Date_Time %>%  julian.Date() %>% as.numeric() # convert to numeric date format for model
df2$Date_Time<-df2$Date_Time - min(df2$Date_Time) # scale date to start at zero for model

#hist(df$Stability) # looks Gaussian
olm<-lm(Stability ~ 0 + Date_Time,data = df2) # linear model
summary(olm)
#plot(olm)

## break-point model ##
os <- segmented(olm, 
                seg.Z = ~ Date_Time, # which variables to break
                psi = c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(), # break at Trami
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric()), # break after typhoons
                control = seg.control(it.max = 0)) # it.max = 0 prevents bootstrap procedure (i.e. forces manual break-point)

AIC(os,olm) # break point model performs better

## davies test of the change in slope after break points
davies.test(olm,values = c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(), # break at Trami
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric())) # break after typhoons
summary(os)

# get dates of manual breakpoint
Psi_1<-df$Date_Time[df$Period %in% 'Trami'][1]
Psi_2<-df$Date_Time[df$Period %in% 'Post-typhoon'][1]

# compare pre- and post-break acoustic index values
Break_results<-df %>% 
  filter(Period %in% c('Pre-typhoon','Post-typhoon')) %>% 
  group_by(Period) %>% 
  summarise(Med=median(Stability),
            Lo_95=quantile(Stability,probs = 0.05),
            Up_95=quantile(Stability,probs = 0.95))
Break_results$Period<-Break_results$Period %>% as.character() %>% parse_factor(levels = c('Pre-typhoon','Post-typhoon'))
```

Plot results:

```{r}
plot1<-df %>% ggplot(aes(x = Date_Time,
                  y = Stability)) +
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Trami'][1],lty = 2) + 
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Post-typhoon'][1],lty = 2) + 
  geom_line(show.legend = F) + 
  labs(x = "Time",
       y = expression(paste("NDSI"["Bio"]," spatial variability"))) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max())) 

plot2<-Break_results %>% ggplot(aes(x = Period,
                  y = Med,
                  ymin = Lo_95,
                  ymax = Up_95,
                  shape = Period)) +
  geom_pointrange(fatten = 5,
                  show.legend = F) + 
  labs(x = "Time period",
       y = element_blank()) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

panel_a<-plot1 + plot2 + plot_layout(widths = c(3,1))
panel_a
```

Now check for landuse effect:

```{r}
# prepare data
df<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Bio" & response_group %in% c('Forest_Var','Developed_Var')) # get pre vs post data for comparison
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
colnames(df)[4]<-'Landuse'
df$Landuse<-df$Landuse %>% as.character() %>% parse_factor(levels = c('Forest','Developed')) # change levels for model
df2<-df
df2$Date_Time<-df2$Date_Time %>%  julian.Date() %>% as.numeric() # convert to numeric date format for model
df2$Date_Time<-df2$Date_Time - min(df2$Date_Time) # scale date to start at zero for model

# split out time series for each land use class separately
temp<-model.matrix(~ 0 + df2$Landuse)*df2$Date_Time
date_for<-temp[,1]
date_dev<-temp[,2]
rm(temp)

#hist(df$Stability) # looks Gaussian
olm<-lm(Stability ~ 0 + Landuse + date_for + date_dev,data = df2) # linear model

## break-point model ##
os <- segmented(olm, 
                seg.Z = ~ date_for + date_dev, # which variables to break
                psi = list(date_for=c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(), # break at Trami
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric()), # break after typhoons
                  date_dev=c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(), # break at Trami
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric())), # break after typhoons
                control = seg.control(it.max = 0)) # it.max = 0 prevents bootstrap procedure (i.e. forces manual break-point)

AIC(os,olm) # break point model performs better

## davies test of the change in slope after break points
davies.test(olm,seg.Z = ~ date_for,
            values = c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(),
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric())) # test for change in slope of forest sites
davies.test(olm,seg.Z = ~ date_dev,
            values = c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(),
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric())) # test for change in slope of developed sites
summary(os)


# get dates of manual breakpoint
Psi_1<-df$Date_Time[df$Period %in% 'Trami'][1]
Psi_2<-df$Date_Time[df$Period %in% 'Post-typhoon'][1]

# compare pre- and post-break acoustic index values
Break_results<-df %>% 
  filter(Period %in% c('Pre-typhoon','Post-typhoon')) %>% 
  group_by(Landuse,Period) %>% 
  summarise(Med=median(Stability),
            Lo_95=quantile(Stability,probs = 0.05),
            Up_95=quantile(Stability,probs = 0.95))
Break_results$Period<-Break_results$Period %>% as.character() %>% parse_factor(levels = c('Pre-typhoon','Post-typhoon'))
Break_results$Landuse<-Break_results$Landuse %>% as.character() %>% parse_factor(levels = c('Forest','Developed'))
```

Plot results:

```{r}
plot1<-df %>% ggplot(aes(x = Date_Time,
                  y = Stability,
                  col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Trami'][1],lty = 2) + 
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Post-typhoon'][1],lty = 2) + 
  geom_line(show.legend = F) + 
  labs(x = "Time",
       y = expression(paste("NDSI"["Bio"]," spatial variability"))) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max())) 

plot2<-Break_results %>% ggplot(aes(x = Landuse,
                  y = Med,
                  ymin = Lo_95,
                  ymax = Up_95,
                  col = Landuse,
                  shape = Period)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_pointrange(position = position_jitterdodge(),
                  fatten = 5,
                  show.legend = F) + 
  labs(x = "Landuse",
       y = element_blank()) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

panel_b<-plot1 + plot2 + plot_layout(widths = c(3,1))
panel_b
```

```{r}
panel_a / panel_b
```

**NDSI_Anthro - no effect**

```{r}
# prepare data
df<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Anth" & response_group %in% 'Total_var') # get pre vs post data for comparison
df2<-df
df2$Date_Time<-df2$Date_Time %>%  julian.Date() %>% as.numeric() # convert to numeric date format for model
df2$Date_Time<-df2$Date_Time - min(df2$Date_Time) # scale date to start at zero for model

#hist(df$Stability) # looks Gaussian
olm<-lm(Stability ~ 0 + Date_Time,data = df2) # linear model
summary(olm)
#plot(olm)

## break-point model ##
os <- segmented(olm, 
                seg.Z = ~ Date_Time, # which variables to break
                psi = c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(), # break at Trami
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric()), # break after typhoons
                control = seg.control(it.max = 0)) # it.max = 0 prevents bootstrap procedure (i.e. forces manual break-point)

AIC(os,olm) # break point model performs better

## davies test of the change in slope after break points
davies.test(olm,values = c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(), # break at Trami
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric())) # break after typhoons
summary(os)

# get dates of manual breakpoint
Psi_1<-df$Date_Time[df$Period %in% 'Trami'][1]
Psi_2<-df$Date_Time[df$Period %in% 'Post-typhoon'][1]

# compare pre- and post-break acoustic index values
Break_results<-df %>% 
  filter(Period %in% c('Pre-typhoon','Post-typhoon')) %>% 
  group_by(Period) %>% 
  summarise(Med=median(Stability),
            Lo_95=quantile(Stability,probs = 0.05),
            Up_95=quantile(Stability,probs = 0.95))
Break_results$Period<-Break_results$Period %>% as.character() %>% parse_factor(levels = c('Pre-typhoon','Post-typhoon'))
```

Plot results:

```{r}
plot1<-df %>% ggplot(aes(x = Date_Time,
                  y = Stability)) +
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Trami'][1],lty = 2) + 
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Post-typhoon'][1],lty = 2) + 
  geom_line(show.legend = F) + 
  labs(x = "Time",
       y = expression(paste("NDSI"["Anthro"]," spatial variability"))) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max())) 

plot2<-Break_results %>% ggplot(aes(x = Period,
                  y = Med,
                  ymin = Lo_95,
                  ymax = Up_95,
                  shape = Period)) +
  geom_pointrange(fatten = 5,
                  show.legend = F) + 
  labs(x = "Time period",
       y = element_blank()) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

panel_a<-plot1 + plot2 + plot_layout(widths = c(3,1))
panel_a
```

NB: model slopes differ slightly so Davies test is sig.

Now check for landuse effect:

```{r}
# prepare data
df<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Anth" & response_group %in% c('Forest_Var','Developed_Var')) # get pre vs post data for comparison
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
colnames(df)[4]<-'Landuse'
df$Landuse<-df$Landuse %>% as.character() %>% parse_factor(levels = c('Forest','Developed')) # change levels for model
df2<-df
df2$Date_Time<-df2$Date_Time %>%  julian.Date() %>% as.numeric() # convert to numeric date format for model
df2$Date_Time<-df2$Date_Time - min(df2$Date_Time) # scale date to start at zero for model

# split out time series for each land use class separately
temp<-model.matrix(~ 0 + df2$Landuse)*df2$Date_Time
date_for<-temp[,1]
date_dev<-temp[,2]
rm(temp)

#hist(df$Stability) # looks Gaussian
olm<-lm(Stability ~ 0 + Landuse + date_for + date_dev,data = df2) # linear model

## break-point model ##
os <- segmented(olm, 
                seg.Z = ~ date_for + date_dev, # which variables to break
                psi = list(date_for=c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(), # break at Trami
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric()), # break after typhoons
                  date_dev=c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(), # break at Trami
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric())), # break after typhoons
                control = seg.control(it.max = 0)) # it.max = 0 prevents bootstrap procedure (i.e. forces manual break-point)

AIC(os,olm) # break point model performs better

## davies test of the change in slope after break points
davies.test(olm,seg.Z = ~ date_for,
            values = c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(),
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric())) # test for change in slope of forest sites
davies.test(olm,seg.Z = ~ date_dev,
            values = c(df$Date_Time[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric(),
                  df$Date_Time[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - 
                  df$Date_Time[1] %>% julian.Date() %>% as.numeric())) # test for change in slope of developed sites
summary(os)


# get dates of manual breakpoint
Psi_1<-df$Date_Time[df$Period %in% 'Trami'][1]
Psi_2<-df$Date_Time[df$Period %in% 'Post-typhoon'][1]

# compare pre- and post-break acoustic index values
Break_results<-df %>% 
  filter(Period %in% c('Pre-typhoon','Post-typhoon')) %>% 
  group_by(Landuse,Period) %>% 
  summarise(Med=median(Stability),
            Lo_95=quantile(Stability,probs = 0.05),
            Up_95=quantile(Stability,probs = 0.95))
Break_results$Period<-Break_results$Period %>% as.character() %>% parse_factor(levels = c('Pre-typhoon','Post-typhoon'))
Break_results$Landuse<-Break_results$Landuse %>% as.character() %>% parse_factor(levels = c('Forest','Developed'))
```

Plot results:

```{r}
plot1<-df %>% ggplot(aes(x = Date_Time,
                  y = Stability,
                  col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Trami'][1],lty = 2) + 
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Post-typhoon'][1],lty = 2) + 
  geom_line(show.legend = F) + 
  labs(x = "Time",
       y = expression(paste("NDSI"["Anthro"]," spatial variability"))) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max())) 

plot2<-Break_results %>% ggplot(aes(x = Landuse,
                  y = Med,
                  ymin = Lo_95,
                  ymax = Up_95,
                  col = Landuse,
                  shape = Period)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_pointrange(position = position_jitterdodge(),
                  fatten = 5,
                  show.legend = F) + 
  labs(x = "Landuse",
       y = element_blank()) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

panel_b<-plot1 + plot2 + plot_layout(widths = c(3,1))
panel_b
```

```{r}
panel_a / panel_b
```

NB: model slopes differ slightly so Davies test is sig.

NB: this is very reassuring - that what we're seeing in the spatial variability results is biotic and independent of background noise. If results weren't driven by site differences in biotic responses, we'd see them follow closely the overall trend like for Anthropophony.

### Bird detections

NB: Bird detections were not made at every site, so the random site effect fills in the missing sites when constructing posterior draws etc. (we simply ignore those results from sites where detections were not observed).

## bird detection mean states

**Total detections - species x typhoon effect**

```{r}
dat_pre<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.5 & response_variable %in% 'Pre_mean') 
dat_post<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.5 & response_variable %in% 'Post_mean') 
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)

# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))

df$Stability<-df$Stability+1 # try this to run lognormal model (cannot have zero values)

# set weakly informative priors
all_priors<-c(
  set_prior("normal(0, 2)",coef = "LanduseDeveloped"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:Species_IDOtus_elegans"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:TyphoonPost"),
  set_prior("normal(0, 2)",coef = "Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "Species_IDOtus_elegans"),
  set_prior("normal(0, 2)",coef = "TyphoonPost"),
  set_prior("normal(0, 2)",coef = "TyphoonPost:Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "TyphoonPost:Species_IDOtus_elegans"))

# Fit bayesian mixed effects model
mod_nonspatial_log <- 
  brm(data = df, family = lognormal(),
      round(Stability) ~ 1 + Landuse + Typhoon + Species_ID + # used round() as poisson needs integers
        Landuse:Typhoon + Landuse:Species_ID + Typhoon:Species_ID + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666, prior = all_priors)

brms::mcmc_plot(mod_nonspatial_log, type = "trace") + theme_cowplot()
#check for agreement of chains
brms::mcmc_plot(mod_nonspatial_log, type = "dens_overlay") + theme_cowplot()
# plot posterior probabilities
brms::mcmc_plot(mod_nonspatial_log, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()
pp_check(mod_nonspatial_log, ndraws = 500) + theme_cowplot() +  scale_x_continuous(limits = c(0,50)) # good fit to data

bayes_R2(mod_nonspatial_log)

bres <- residuals(mod_nonspatial_log)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T))
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
ape::Moran.I(bres, d_mat_inv)

summary(mod_nonspatial_log)
```

Plot main species effect:

```{r}
# Horornis #
mut_mod<-mod_nonspatial_log %>%
  spread_draws(b_Species_IDHorornis_diphone, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_Species_IDHorornis_diphone + r_Site_ID) # get posterior distribution data for plotting
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
} # determine whether credible intervals span zero, and store as binary (to show in plot): 
rm(temp) 
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor
horornisplot <- mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","navajowhite")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (species effect)",
       y = "") + 
  cowplot::theme_minimal_grid()

# Otus #
mut_mod<-mod_nonspatial_log %>%
  spread_draws(b_Species_IDOtus_elegans, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_Species_IDOtus_elegans + r_Site_ID) # get posterior distribution data for plotting
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
} # determine whether credible intervals span zero, and store as binary (to show in plot): 
rm(temp)
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor
otusplot <-mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","navajowhite")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (species effect)",
       y = "") + 
  cowplot::theme_minimal_grid()

# plots #
plot_grid(horornisplot, otusplot, 
          ncol = 2, align = "hv", 
          labels = c("Horonis", "Otus"))
```

Plot typhoon x species interaction:

```{r}
# Corvus #
mut_mod<-mod_nonspatial_log %>%
  spread_draws(b_TyphoonPost, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_TyphoonPost + r_Site_ID) # get posterior distribution data for plotting
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
} # determine whether credible intervals span zero, and store as binary (to show in plot): 
rm(temp)
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor
corvusplot <- mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","skyblue")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (typhoon effect)",
       y = "Site") + 
  cowplot::theme_minimal_grid()

# Horornis #
mut_mod<-mod_nonspatial_log %>%
  spread_draws(b_TyphoonPost, `b_TyphoonPost:Species_IDHorornis_diphone`, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_TyphoonPost + `b_TyphoonPost:Species_IDHorornis_diphone` + r_Site_ID) # get posterior distribution data for plotting
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
} # determine whether credible intervals span zero, and store as binary (to show in plot): 
rm(temp) 
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor
horornisplot <- mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","skyblue")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (typhoon effect)",
       y = "") + 
  cowplot::theme_minimal_grid()

# Otus #
mut_mod<-mod_nonspatial_log %>%
  spread_draws(b_TyphoonPost, `b_TyphoonPost:Species_IDOtus_elegans`, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_TyphoonPost + `b_TyphoonPost:Species_IDOtus_elegans` + r_Site_ID) # get posterior distribution data for plotting
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
} # determine whether credible intervals span zero, and store as binary (to show in plot): 
rm(temp)
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor
otusplot <-mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","skyblue")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (typhoon effect)",
       y = "") + 
  cowplot::theme_minimal_grid()

# plots #
plot_grid(corvusplot, horornisplot, otusplot, 
          ncol = 3, align = "hv", 
          labels = c("Corvus", "Horonis", "Otus"))
```

## bird detection temporal variability

**Total detections - typhoon effect**

```{r}
dat_pre<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.5 & response_variable %in% 'Pre_Var') 
dat_post<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.5 & response_variable %in% 'Post_Var') 
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)

# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))

df$Stability<-df$Stability+1 # try this to run lognormal model (cannot have zero values)

# set weakly informative priors
all_priors<-c(
  set_prior("normal(0, 2)",coef = "LanduseDeveloped"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:Species_IDOtus_elegans"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:TyphoonPost"),
  set_prior("normal(0, 2)",coef = "Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "Species_IDOtus_elegans"),
  set_prior("normal(0, 2)",coef = "TyphoonPost"),
  set_prior("normal(0, 2)",coef = "TyphoonPost:Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "TyphoonPost:Species_IDOtus_elegans"))

# Fit bayesian mixed effects model
mod_nonspatial_log <- 
  brm(data = df, family = lognormal(),
      round(Stability) ~ 1 + Landuse + Typhoon + Species_ID + # used round() as poisson needs integers
        Landuse:Typhoon + Landuse:Species_ID + Typhoon:Species_ID + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666, prior = all_priors)

brms::mcmc_plot(mod_nonspatial_log, type = "trace") + theme_cowplot()
#check for agreement of chains
brms::mcmc_plot(mod_nonspatial_log, type = "dens_overlay") + theme_cowplot()
# plot posterior probabilities
brms::mcmc_plot(mod_nonspatial_log, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()
pp_check(mod_nonspatial_log, ndraws = 500) + theme_cowplot() +  scale_x_continuous(limits = c(0,50)) # good fit to data

bayes_R2(mod_nonspatial_log)

bres <- residuals(mod_nonspatial_log)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T))
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
ape::Moran.I(bres, d_mat_inv)

summary(mod_nonspatial_log)
```

Plot typhoon effect:

```{r}
mut_mod<-mod_nonspatial_log %>%
  spread_draws(b_TyphoonPost, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_TyphoonPost + r_Site_ID) # get posterior distribution data for plotting
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
} # determine whether credible intervals span zero, and store as binary (to show in plot): 
rm(temp) 
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor
mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","skyblue")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (typhoon effect)",
       y = "") + 
  cowplot::theme_minimal_grid()
```

## bird detection spatial variability

**bird detections - species effect**

```{r}
# prepare data
df<-tidy.spatial_bird %>%
  filter(response_group %in% 'Total_Var') # get pre vs post data for comparison
df2<-df
df2$Date<-df2$Date %>%  julian.Date() %>% as.numeric() # convert to numeric date format for model
df2$Date<-df2$Date - min(df2$Date) # scale date to start at zero for model

# split out time series for each species class separately
temp<-model.matrix(~ 0 + df2$Species)*df2$Date
date_Corv<-temp[,1]
date_Horo<-temp[,2]
date_Otus<-temp[,3]
rm(temp)

#hist(df$Stability) # looks lognormal
olm<-glm(Stability ~ 0 + Species + date_Corv + date_Horo + date_Otus,
         data = df2,family = gaussian(link = 'log')) # linear model

summary(olm)
#plot(olm)

# get break points
Psi_1<-df$Date[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - df$Date[1] %>% julian.Date() %>% as.numeric()
Psi_2<-df$Date[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - df$Date[1] %>% julian.Date() %>% as.numeric()

## break-point model ##
os <- segmented(olm, 
                seg.Z = ~ date_Corv + date_Horo + date_Otus, # which variables to break
                psi = list(date_Corv=c(Psi_1,Psi_2),
                           date_Horo=c(Psi_1,Psi_2),
                           date_Otus=c(Psi_1,Psi_2)),
                control = seg.control(it.max = 0)) # it.max = 0 prevents bootstrap procedure (i.e. forces manual break-point)

AIC(os,olm) # break point model performs better

## davies test of the change in slope after break points
davies.test(olm,seg.Z = ~ date_Corv,
            values = c(Psi_1,Psi_2)) # test for change in slope of forest sites
davies.test(olm,seg.Z = ~ date_Horo,
            values = c(Psi_1,Psi_2)) # test for change in slope of developed sites
davies.test(olm,seg.Z = ~ date_Otus,
            values = c(Psi_1,Psi_2)) # test for change in slope of developed sites

summary(os)

# compare pre- and post-break acoustic index values
Break_results<-df %>% 
  filter(Period %in% c('Pre-typhoon','Post-typhoon')) %>% 
  group_by(Species,Period) %>% 
  summarise(Med=median(Stability),
            Lo_95=quantile(Stability,probs = 0.05),
            Up_95=quantile(Stability,probs = 0.95))
Break_results$Period<-Break_results$Period %>% as.character() %>% parse_factor(levels = c('Pre-typhoon','Post-typhoon'))
Break_results$Species<-Break_results$Species %>% as.character() %>% parse_factor(levels = c('Corvus_macrorhynchos','Horornis_diphone','Otus_elegans'))
```

Plot results:

```{r}
Sp_labs<-c('C. macrorhynchos','H. diphone','O. elegans')
names(Sp_labs)<-c('Corvus_macrorhynchos','Horornis_diphone','Otus_elegans')

plot1<-df %>% ggplot(aes(x = Date,
                  y = Stability,
                  alpha = Species)) +
  scale_alpha_manual(values = c(1,0.6,0.3)) +
#  scale_colour_manual(values = c("black","grey50","grey80")) +
  geom_vline(xintercept = df$Date[df$Period %in% 'Trami'][1],lty = 2) + 
  geom_vline(xintercept = df$Date[df$Period %in% 'Post-typhoon'][1],lty = 2) + 
  geom_line(show.legend = F) + 
  labs(x = "Time",
       y = "Species detection spatial variability") + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max())) 

plot2<-Break_results %>% ggplot(aes(x = Species,
                  y = Med,
                  ymin = Lo_95,
                  ymax = Up_95,
                  alpha = Species,
                  shape = Period)) +
  scale_alpha_manual(values = c(1,0.6,0.3)) +
#  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_pointrange(position = position_jitterdodge(),
                  fatten = 5,
                  show.legend = F) + 
  labs(x = "Species",
       y = element_blank()) + 
  scale_x_discrete(labels = Sp_labs) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

panel_a<-plot1 + plot2 + plot_layout(widths = c(3,1))
panel_a
```

Now check for landuse effect:

```{r}
# prepare data
df<-tidy.spatial_bird %>%
  filter(response_group %in% c('Forest_Var','Developed_Var')) # get pre vs post data for comparison
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
colnames(df)[4]<-'Landuse'
df$Landuse<-df$Landuse %>% as.character() %>% parse_factor(levels = c('Forest','Developed')) # change levels for model
df$Stability[df$Species %in% 'Otus_elegans' & df$Landuse %in% 'Forest']<-df$Stability[df$Species %in% 'Otus_elegans' & df$Landuse %in% 'Developed'] # fix error in forest owl data (showing up as developed for some reason)
df$Stability[df$Species %in% 'Otus_elegans' & df$Landuse %in% 'Developed']<-NA # fix error in forest owl data
df2<-df
df2$Date<-df2$Date %>%  julian.Date() %>% as.numeric() # convert to numeric date format for model
df2$Date<-df2$Date - min(df2$Date) # scale date to start at zero for model

# split out time series for each species class separately
temp<-model.matrix(~ 0 + df2$Species * df2$Landuse)*df2$Date
date_Corv_for<-temp[,1]
date_Horo_for<-temp[,2]
date_Otus_for<-temp[,3]
date_Corv_dev<-temp[,4]
date_Horo_dev<-temp[,5]
rm(temp)

#hist(df$Stability) # looks lognormal
olm<-glm(Stability ~ 0 + Species + Landuse + date_Corv_for + date_Horo_for + date_Otus_for + date_Corv_dev + date_Horo_dev,
         data = df2,family = gaussian(link = 'log')) # linear model

summary(olm)
#plot(olm)

# get break points
Psi_1<-df$Date[df$Period %in% 'Trami'][1] %>%  julian.Date() %>% as.numeric() - df$Date[1] %>% julian.Date() %>% as.numeric()
Psi_2<-df$Date[df$Period %in% 'Post-typhoon'][1] %>%  julian.Date() %>% as.numeric() - df$Date[1] %>% julian.Date() %>% as.numeric()

## break-point model ##
os <- segmented(olm, 
                seg.Z = ~ date_Corv_for + date_Horo_for + date_Otus_for + date_Corv_dev + date_Horo_dev, # which variables to break
                psi = list(date_Corv_for=c(Psi_1,Psi_2),
                           date_Horo_for=c(Psi_1,Psi_2),
                           date_Otus_for=c(Psi_1,Psi_2),
                           date_Corv_dev=c(Psi_1,Psi_2),
                           date_Horo_dev=c(Psi_1,Psi_2)),
                control = seg.control(it.max = 0)) # it.max = 0 prevents bootstrap procedure (i.e. forces manual break-point)

AIC(os,olm) # break point model performs better

## davies test of the change in slope after break points
davies.test(olm,seg.Z = ~ date_Corv_for,
            values = c(Psi_1,Psi_2)) # test for change in slope of forest sites
davies.test(olm,seg.Z = ~ date_Horo_for,
            values = c(Psi_1,Psi_2)) # test for change in slope of developed sites
davies.test(olm,seg.Z = ~ date_Otus_for,
            values = c(Psi_1,Psi_2)) # test for change in slope of developed sites
davies.test(olm,seg.Z = ~ date_Corv_dev,
            values = c(Psi_1,Psi_2)) # test for change in slope of forest sites
davies.test(olm,seg.Z = ~ date_Horo_dev,
            values = c(Psi_1,Psi_2)) # test for change in slope of developed sites
summary(os)

# compare pre- and post-break acoustic index values
Break_results<-df %>% 
  filter(Period %in% c('Pre-typhoon','Post-typhoon')) %>% 
  group_by(Species,Landuse,Period) %>% 
  summarise(Med=median(Stability,na.rm = T),
            Lo_95=quantile(Stability,probs = 0.05,na.rm = T),
            Up_95=quantile(Stability,probs = 0.95,na.rm = T))

Break_results$Period<-Break_results$Period %>% as.character() %>% parse_factor(levels = c('Pre-typhoon','Post-typhoon'))
Break_results$Landuse<-Break_results$Landuse %>% as.character() %>% parse_factor(levels = c('Forest','Developed'))
Break_results$Species<-Break_results$Species %>% as.character() %>% parse_factor(levels = c('Corvus_macrorhynchos','Horornis_diphone','Otus_elegans'))
```

Plot results:

```{r}
plot1<-df %>% ggplot(aes(x = Date,
                  y = Stability,
                  alpha = Species,
                  col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  scale_alpha_manual(values = c(1,0.6,0.3)) +
  geom_vline(xintercept = df$Date[df$Period %in% 'Trami'][1],lty = 2) + 
  geom_vline(xintercept = df$Date[df$Period %in% 'Post-typhoon'][1],lty = 2) + 
  geom_line(show.legend = F) + 
  labs(x = "Time",
       y = "Species detection spatial variability") + 
  theme_cowplot(12) + 
  theme(strip.background = element_rect(fill = 'white')) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max())) + 
  facet_grid(Species ~ .,
             labeller = labeller(Species = Sp_labs))

plot2<-Break_results %>% ggplot(aes(x = Species,
                  y = Med,
                  ymin = Lo_95,
                  ymax = Up_95,
                  alpha = Species,
                  col = Landuse,
                  shape = Period)) +
  scale_alpha_manual(values = c(1,0.6,0.3)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_pointrange(position = position_jitterdodge(),
                  fatten = 5,
                  show.legend = F) + 
  labs(x = 'Species',
       y = element_blank()) + 
  scale_x_discrete(labels = Sp_labs) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

panel_b<-plot1 + plot2 + plot_layout(widths = c(3,1))
panel_b
```

```{r}
panel_a / panel_b
```

\*\* Do SAME BUT FOR DIFFERENT TIME HORIZONS BEFORE AND AFTER TYPHOONS - TO SHOW RESULTS DON'T DEPEND ON TIME BEFORE/AFTER TYPHOONS

### Figure S2

Finally, compare different automatic filtering thresholds for species detection confidence. Test the mean species effect on Horonis_diphone under three confidence thresholds. NB: to speed this up, we'll run 10x fewer iterations in the models. 

**Threshold = 0.5 **

```{r}
dat_pre<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.5 & response_variable %in% 'Pre_mean') 
dat_post<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.5 & response_variable %in% 'Post_mean') 
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Stability<-df$Stability+1 # try this to run lognormal model (cannot have zero values)

# set weakly informative priors
all_priors<-c(
  set_prior("normal(0, 2)",coef = "LanduseDeveloped"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:Species_IDOtus_elegans"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:TyphoonPost"),
  set_prior("normal(0, 2)",coef = "Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "Species_IDOtus_elegans"),
  set_prior("normal(0, 2)",coef = "TyphoonPost"),
  set_prior("normal(0, 2)",coef = "TyphoonPost:Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "TyphoonPost:Species_IDOtus_elegans"))

# Fit bayesian mixed effects model
mod_nonspatial_log <- 
  brm(data = df, family = lognormal(),
      round(Stability) ~ 1 + Landuse + Typhoon + Species_ID + # used round() as poisson needs integers
        Landuse:Typhoon + Landuse:Species_ID + Typhoon:Species_ID + (1|Site_ID),
      iter = 5e3, warmup = 500, chains = 4, cores = 4, thin = 2,
      seed = 666, prior = all_priors)

summary(mod_nonspatial_log)

#Plot - Horornis #
mut_mod<-mod_nonspatial_log %>%
  spread_draws(b_Species_IDHorornis_diphone, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_Species_IDHorornis_diphone + r_Site_ID) # get posterior distribution data for plotting
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
} # determine whether credible intervals span zero, and store as binary (to show in plot): 
rm(temp) 
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor
Plot_50 <- mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","navajowhite")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (species effect)",
       y = "") + 
  cowplot::theme_minimal_grid()
```

**Threshold = 0.75 **

```{r}
dat_pre<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.75 & response_variable %in% 'Pre_mean') 
dat_post<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.75 & response_variable %in% 'Post_mean') 
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Stability<-df$Stability+1 # try this to run lognormal model (cannot have zero values)

# set weakly informative priors
all_priors<-c(
  set_prior("normal(0, 2)",coef = "LanduseDeveloped"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:Species_IDOtus_elegans"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:TyphoonPost"),
  set_prior("normal(0, 2)",coef = "Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "Species_IDOtus_elegans"),
  set_prior("normal(0, 2)",coef = "TyphoonPost"),
  set_prior("normal(0, 2)",coef = "TyphoonPost:Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "TyphoonPost:Species_IDOtus_elegans"))

# Fit bayesian mixed effects model
mod_nonspatial_log <- 
  brm(data = df, family = lognormal(),
      round(Stability) ~ 1 + Landuse + Typhoon + Species_ID + # used round() as poisson needs integers
        Landuse:Typhoon + Landuse:Species_ID + Typhoon:Species_ID + (1|Site_ID),
      iter = 5e3, warmup = 500, chains = 4, cores = 4, thin = 2,
      seed = 666, prior = all_priors)

summary(mod_nonspatial_log)

#Plot - Horornis #
mut_mod<-mod_nonspatial_log %>%
  spread_draws(b_Species_IDHorornis_diphone, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_Species_IDHorornis_diphone + r_Site_ID) # get posterior distribution data for plotting
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
} # determine whether credible intervals span zero, and store as binary (to show in plot): 
rm(temp) 
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor
Plot_75 <- mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","navajowhite")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (species effect)",
       y = "") + 
  cowplot::theme_minimal_grid()
```

**Threshold = 0.9**

```{r}
dat_pre<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.9 & response_variable %in% 'Pre_mean') 
dat_post<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.9 & response_variable %in% 'Post_mean') 
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Stability<-df$Stability+1 # try this to run lognormal model (cannot have zero values)

# set weakly informative priors
all_priors<-c(
  set_prior("normal(0, 2)",coef = "LanduseDeveloped"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:Species_IDOtus_elegans"),
  set_prior("normal(0, 2)",coef = "LanduseDeveloped:TyphoonPost"),
  set_prior("normal(0, 2)",coef = "Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "Species_IDOtus_elegans"),
  set_prior("normal(0, 2)",coef = "TyphoonPost"),
  set_prior("normal(0, 2)",coef = "TyphoonPost:Species_IDHorornis_diphone"),
  set_prior("normal(0, 2)",coef = "TyphoonPost:Species_IDOtus_elegans"))

# Fit bayesian mixed effects model
mod_nonspatial_log <- 
  brm(data = df, family = lognormal(),
      round(Stability) ~ 1 + Landuse + Typhoon + Species_ID + # used round() as poisson needs integers
        Landuse:Typhoon + Landuse:Species_ID + Typhoon:Species_ID + (1|Site_ID),
      iter = 5e3, warmup = 500, chains = 4, cores = 4, thin = 2,
      seed = 666, prior = all_priors)

summary(mod_nonspatial_log)

#Plot - Horornis #
mut_mod<-mod_nonspatial_log %>%
  spread_draws(b_Species_IDHorornis_diphone, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_Species_IDHorornis_diphone + r_Site_ID) # get posterior distribution data for plotting
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
} # determine whether credible intervals span zero, and store as binary (to show in plot): 
rm(temp) 
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor
Plot_90 <- mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","navajowhite")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (species effect)",
       y = "") + 
  cowplot::theme_minimal_grid()
```

Compare plots:

```{r}
# plots #
plot_grid(Plot_50, Plot_75, Plot_90, 
          ncol = 3, align = "hv", 
          labels = c("Threshold: 0.5", "Threshold: 0.75", "Threshold: 0.9"))
```