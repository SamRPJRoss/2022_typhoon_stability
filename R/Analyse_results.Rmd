---
title: "Analysis and Figures"
author: "Samuel R.P-J. Ross"
date: '2022-07-08'
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## Packages:
library(nlme)
library(patchwork)
library(here)
library(brms)
library(tidybayes)
library(cowplot)
library(ape)
library(dplyr)
library(ggplot2)
library(tibble)
library(tidyr)
library(readr)
library(purrr)
library(stringr)
library(forcats)
#library(simpleboot)
library(segmented)

# get data
load(here("Data/Stability_Acoustic_Indices.rda"))
load(here("Data/Stability_Species_Detections.rda"))

# get site names ordered by land use PC1 for later use in figures
load(here("Data/all_landuse.rda"))
Site_order<-Landuse_1000$site_id[order(Landuse_1000$PC1)]
rm(Landuse_1000)
```

This markdown is for building models to test effects of land use and typhoons on acoustic indices and bird species detections. 
Modeling framework uses Bayesian models to test for effects of typhoons and land use (plus their interaction) on means and variabilities of acoustic indices and bird detections. Also tests land use effect on acoustic index resistance and recovery.
Can test for spatial autocorrelation of model residuals and fit spatial error terms where needed.

### Acoustic indices

## acoustic index mean states

**NDSI - negative change after typhoon**

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.stability_AI %>%
  filter(Index %in% "NDSI" & response_variable %in% 'Pre_mean') 
dat_post<-tidy.stability_AI %>%
  filter(Index %in% "NDSI" & response_variable %in% 'Post_mean')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
#names(df)[1] <- names(Landuse_1000)[1]
#df <- left_join(df, Landuse_1000, by = "site_id")

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse * Typhoon + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## typhoon has an effect ##

mut_mod<-mod_nonspatial_beta %>%
  spread_draws(b_TyphoonPost, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_TyphoonPost + r_Site_ID) # get posterior distribution data for plotting

# determine whether credible intervals span zero, and store as binary (to show in plot): 
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
}
rm(temp)
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor

# plot posterior typhoon effect
mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","skyblue")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (typhoon effect)",
       y = "Site") + 
  cowplot::theme_minimal_grid(font_size = 14,
                              colour = "grey92")

## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

**NDSI_Bio - no effect of typhoon or land use**

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Bio" & response_variable %in% 'Pre_mean') 
dat_post<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Bio" & response_variable %in% 'Post_mean')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
#names(df)[1] <- names(Landuse_1000)[1]
#df <- left_join(df, Landuse_1000, by = "site_id")

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse * Typhoon + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

**NDSI_Anthro - positive change after typhoon**

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Anth" & response_variable %in% 'Pre_mean') 
dat_post<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Anth" & response_variable %in% 'Post_mean')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
#names(df)[1] <- names(Landuse_1000)[1]
#df <- left_join(df, Landuse_1000, by = "site_id")

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse * Typhoon + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## typhoon has an effect ##

mut_mod<-mod_nonspatial_beta %>%
  spread_draws(b_TyphoonPost, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_TyphoonPost + r_Site_ID) # get posterior distribution data for plotting

# determine whether credible intervals span zero, and store as binary (to show in plot): 
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
}
rm(temp)
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor

# plot posterior typhoon effect
mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","skyblue")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (typhoon effect)",
       y = "Site") + 
  cowplot::theme_minimal_grid(font_size = 14,
                              colour = "grey92")

## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

## acoustic index temporal variability

**NDSI - no effect of typhoon or land use**

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.stability_AI %>%
  filter(Index %in% "NDSI" & response_variable %in% 'Pre_Var') 
dat_post<-tidy.stability_AI %>%
  filter(Index %in% "NDSI" & response_variable %in% 'Post_Var')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
#names(df)[1] <- names(Landuse_1000)[1]
#df <- left_join(df, Landuse_1000, by = "site_id")

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

# fit random intercept and slope model because random slope model didn't converge well.
mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse * Typhoon + (1+Landuse*Typhoon|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

**NDSI_Bio - no effect of typhoon or land use**

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Bio" & response_variable %in% 'Pre_Var') 
dat_post<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Bio" & response_variable %in% 'Post_Var')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
#names(df)[1] <- names(Landuse_1000)[1]
#df <- left_join(df, Landuse_1000, by = "site_id")

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

# fit random intercept and slope model because random slope model didn't converge well.
mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse * Typhoon + (1+Landuse*Typhoon|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

**NDSI_Anthro - no effect of typhoon or land use**

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Anth" & response_variable %in% 'Pre_Var') 
dat_post<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Anth" & response_variable %in% 'Post_Var')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)
#names(df)[1] <- names(Landuse_1000)[1]
#df <- left_join(df, Landuse_1000, by = "site_id")

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

# fit random intercept and slope model because random slope model didn't converge well.
mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse * Typhoon + (1+Landuse*Typhoon|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

## acoustic index resistance

**NDSI - no effect of land use**

```{r}

# get pre vs post data for comparison
df<-tidy.stability_AI %>%
  filter(Index %in% "NDSI" & response_variable %in% 'Resist') 
df<-df[complete.cases(df),]

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

**NDSI_Bio - no effect of land use**

```{r}

# get pre vs post data for comparison
df<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Bio" & response_variable %in% 'Resist') 
df<-df[complete.cases(df),]

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

**NDSI_Anthro - no effect of land use**

```{r}

# get pre vs post data for comparison
df<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Anth" & response_variable %in% 'Resist') 
df<-df[complete.cases(df),]

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

## acoustic index recovery time

**NDSI - no effect of land use**

```{r}

# get pre vs post data for comparison
df<-tidy.stability_AI %>%
  filter(Index %in% "NDSI" & response_variable %in% 'Recov') 
df<-df[complete.cases(df),]

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

**NDSI_Bio - no effect of land use**

```{r}

# get pre vs post data for comparison
df<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Bio" & response_variable %in% 'Recov') 
df<-df[complete.cases(df),]

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

**NDSI_Anthro - no effect of land use**

```{r}

# get pre vs post data for comparison
df<-tidy.stability_AI %>%
  filter(Index %in% "NDSI_Anth" & response_variable %in% 'Recov') 
df<-df[complete.cases(df),]

# change levels for model
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))
#df$site_id<-df$site_id %>% parse_character() %>% parse_factor(levels = c(df$site_id[order(df$PC1)]))

# fit random intercept and slope model because random slope model didn't converge well.
mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse + (1+Landuse|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no effects ##
## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

## Spatial Autocorrelation test
bres <- residuals(mod_nonspatial_beta)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T)) # make distance matrix 
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
Moran.I(bres, d_mat_inv) # non-significant = no spatial autocorrelation

```

## acoustic index spatial variability

Not using same Bayesian models for spatial variability here. Instead, take the nonparametric bootstrap of the CV (spatial variability) values within each day for forest and developed sites separately. Then compare whether boostrap confidence intervals overlap per day and can look for temporal patterns in land use effects on spatial variability. 

**NDSI - typhoon x landuse interaction**

Get 95% CIs of bootstraps per day:

```{r}

# get pre vs post data for comparison
df<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI" & response_group %in% c('Forest_Var','Developed_Var'))
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
colnames(df)[4]<-'Landuse'
df$Landuse<-df$Landuse %>% as.character() %>% parse_factor(levels = c('Forest','Developed')) # change levels for model

# get dates
temp<-df$Date_Time %>% 
  as.character() %>% 
  str_split(pattern = " ",simplify = T)
df$Date<-temp[,1]
rm(temp)

# get output dataframe for bootstrapped results
Spatial_int<-df %>% 
  group_by(Landuse,Date) %>% 
  summarise(Med = NA, Low = NA, High = NA)

#### get this to work by bootstrapping first!! 

# bootstrap and store the median and confidence intervals of the mean bootstrap
for(i in 1:nrow(Spatial_int)){
  
  temp<-df$Stability[df$Landuse %in% Spatial_int$Landuse[i] & df$Date %in% Spatial_int$Date[i]] %>% 
    one.boot(FUN = 'mean',R = 10000,student = F)
  
  Spatial_int$Med[i] <- temp$t %>% median(na.rm = T)
  Spatial_int$Low[i] <- temp$t %>% quantile(na.rm = T, probs = 0.05)
  Spatial_int$High[i] <- temp$t %>% quantile(na.rm = T, probs = 0.95)
  rm(temp)
  
}

```

Plot results: 

```{r}

Spatial_int %>% ggplot(aes(x = Date,
                  y = Med,
                  ymin = Low, 
                  ymax = High,
                  col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = df$Date[df$Period %in% 'Trami'][1],lty = 2) + 
  geom_vline(xintercept = df$Date[df$Period %in% 'Post-typhoon'][1],lty = 2) + 
  geom_line(aes(x = Date,y = Med,group = Landuse)) +
  geom_pointrange() + 
  labs(x = "Date",
       y = "Nonparametric mean bootstrap: NDSI Spatial variability") + 
  theme_cowplot(12) 

  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))





```


Okay but this doesn't test explicitly for an interaction between land use and typhoon period does it? That was kinda the whole point. 


Try a break point model!! 

```{r}

# get pre vs post data for comparison
df<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI" & response_group %in% c('Forest_Var','Developed_Var'))
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
colnames(df)[4]<-'Landuse'
df$Landuse<-df$Landuse %>% as.character() %>% parse_factor(levels = c('Forest','Developed')) # change levels for model

# get dates
temp<-df$Date_Time %>% 
  as.character() %>% 
  str_split(pattern = " ",simplify = T)
df$Date<-temp[,1]
rm(temp)
df$Date<-df$Date %>% parse_date() %>%  julian.Date() %>% as.numeric()








library(glmmTMB)
mod_nonspatial_beta <- 
  glmmTMB(Stability ~ Date,
              ziformula = ~1,
              data = df,
              family = beta_family(link = "logit"),
              REML = FALSE)

#### nb - the issue of "nonconformable arrays" might be because there are multiple values per date (they're not daily averages)

  




 
# split out time series of each land use class (without the response variable)
test<-model.matrix(~ 1 + df$Landuse)*df$Date
df_for<-test[,1]
df_dev<-test[,2]

#test<-model.frame(~ 1 + df$Landuse*df$Date)
#df_for<-test[test[,1] %in% 'Forest',2]
#df_for<-c(df_for,df_for)
#df_dev<-test[test[,1] %in% 'Developed',2]
#df_dev<-c(df_dev,df_dev)

#temp.name<-names(df_for)
#df_for<-unname(df_for)
#df_dev<-unname(df_dev)
#df_dev[1:3072]<-df_for[3073:6144]
#names(df_for)<-temp.name
#names(df_dev)<-temp.name

test.mod<-lm(data = df,Stability ~ 1 + Landuse + df_for + df_dev)
summary(test.mod)

test.seg <- segmented(test.mod, seg.Z = ~ df_for + df_dev,
                      psi = list(df_for=17805,df_dev=17805))
summary(test.seg)

plot.segmented(test.seg,term = df_for,res = T,conf.level = 0.95,col=2)
plot.segmented(test.seg,term = df_dev,res = T,conf.level = 0.95,col=2)

# this almost works, but it's forcing the intercept of df_dev through the origin (zero)






 data("plant")
# attach(plant)
 plant %>%  head()
 X<-model.matrix(~0+plant$group)*plant$time
 head(X)
 time.KV<-X[,1]
 time.KW<-X[,2]
 time.WC<-X[,3]
 
X
plant


 
olm<-lm(y~0+group+ time.KV + time.KW + time.WC)
 os<-segmented(olm, seg.Z= ~ time.KV + time.KW
 + time.WC, psi=list(time.KV=c(300,450),
 time.KW=c(450,600), time.WC=c(300,450)))

```







**NDSI**

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI" & Period %in% 'Pre-typhoon' & response_group %in% 'Total_var') 
dat_post<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI" & Period %in% 'Post-typhoon' & response_group %in% 'Total_var')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)

# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Typhoon,
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## typhoon has an effect ##

## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

```

NB: there's no random effect in this model because date_time is different for each data point... maybe should include date as a random effect somehow?

Issues with model diagnostics (doesn't look a great fit) - random time intercept didn't help but don't fix the issue (caused nonconvergence). Different families seem to help (Beta maybe not best here?)

Same but for forest vs developed: 

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI" & Period %in% 'Pre-typhoon' & response_group %in% c('Developed_Var','Forest_Var')) 
dat_post<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI" & Period %in% 'Post-typhoon' & response_group %in% c('Developed_Var','Forest_Var'))
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)

# change format of landuse information
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
colnames(df)[4]<-'Landuse'

# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Typhoon * Landuse,
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## typhoon has an effect ##

## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

```

Plot time series of results showing land use x typhoon effects:

```{r}

df<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI")
df$response_group[df$response_group %in% 'Total_var']<-'All'
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
df$response_group<-df$response_group %>% parse_character() %>% parse_factor(levels = c('All','Forest','Developed'))

plot1<-df %>% ggplot(aes(x = Date_Time,
                  y = Stability,
                  col = response_group)) +
  scale_colour_manual(values = c('black',"#29a62b","#a629a4")) +
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Trami'][1],lty = 2) + 
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Post-typhoon'][1],lty = 2) + 
  geom_line(show.legend = F) + 
  labs(x = "Time",
       y = "NDSI Spatial variability") + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

df2<-df %>% 
  filter(Period %in% c('Pre-typhoon','Post-typhoon')) %>% 
  group_by(response_group,Period) %>% 
  summarise(Med=median(Stability),
            Low=quantile(Stability,probs = 0.05),
            High=quantile(Stability,probs = 0.95))
df2$Period<-df2$Period %>% parse_character() %>% parse_factor(levels = c('Pre-typhoon','Post-typhoon'))


plot2<-df2 %>% ggplot(aes(x = response_group,
                  y = Med,
                  ymin = Low,
                  ymax = High,
                  col = response_group,
                  shape = Period)) +
  scale_colour_manual(values = c('black',"#29a62b","#a629a4")) +
  geom_pointrange(position = position_jitterdodge(),
                  fatten = 5,
                  show.legend = F) + 
  labs(x = "Land use subset",
       y = element_blank()) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

plot1 + plot2 + plot_layout(widths = c(3,1))
```

For axis legend: "dashed lines delineate the pre- and post-typhoon periods."

**NDSI_Bio **

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Bio" & Period %in% 'Pre-typhoon' & response_group %in% 'Total_var') 
dat_post<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Bio" & Period %in% 'Post-typhoon' & response_group %in% 'Total_var')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)

# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Typhoon,
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## typhoon has an effect ##

## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

```

NB: there's no random effect in this model because date_time is different for each data point... maybe should include date as a random effect somehow?

Issues with model diagnostics (doesn't look a great fit) - random time intercept didn't help but don't fix the issue (caused nonconvergence). Different families seem to help (Beta maybe not best here?)

Same but for forest vs developed: 

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Bio" & Period %in% 'Pre-typhoon' & response_group %in% c('Developed_Var','Forest_Var')) 
dat_post<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Bio" & Period %in% 'Post-typhoon' & response_group %in% c('Developed_Var','Forest_Var'))
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)

# change format of landuse information
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
colnames(df)[4]<-'Landuse'

# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Typhoon * Landuse,
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## typhoon has an effect ##

## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

```
Plot time series of results showing land use x typhoon effects:

```{r}

df<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Bio")
df$response_group[df$response_group %in% 'Total_var']<-'All'
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
df$response_group<-df$response_group %>% parse_character() %>% parse_factor(levels = c('All','Forest','Developed'))

plot1<-df %>% ggplot(aes(x = Date_Time,
                  y = Stability,
                  col = response_group)) +
  scale_colour_manual(values = c('black',"#29a62b","#a629a4")) +
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Trami'][1],lty = 2) + 
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Post-typhoon'][1],lty = 2) + 
  geom_line(show.legend = F) + 
  labs(x = "Time",
       y = "Biophony Spatial variability") + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

df2<-df %>% 
  filter(Period %in% c('Pre-typhoon','Post-typhoon')) %>% 
  group_by(response_group,Period) %>% 
  summarise(Med=median(Stability),
            Low=quantile(Stability,probs = 0.05),
            High=quantile(Stability,probs = 0.95))
df2$Period<-df2$Period %>% parse_character() %>% parse_factor(levels = c('Pre-typhoon','Post-typhoon'))


plot2<-df2 %>% ggplot(aes(x = response_group,
                  y = Med,
                  ymin = Low,
                  ymax = High,
                  col = response_group,
                  shape = Period)) +
  scale_colour_manual(values = c('black',"#29a62b","#a629a4")) +
  geom_pointrange(position = position_jitterdodge(),
                  fatten = 5,
                  show.legend = F) + 
  labs(x = "Land use subset",
       y = element_blank()) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

plot1 + plot2 + plot_layout(widths = c(3,1))
```

For axis legend: "dashed lines delineate the pre- and post-typhoon periods."

**NDSI_Anthro **

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Anth" & Period %in% 'Pre-typhoon' & response_group %in% 'Total_var') 
dat_post<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Anth" & Period %in% 'Post-typhoon' & response_group %in% 'Total_var')
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)

# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Typhoon,
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## typhoon has an effect ##

## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

```

NB: there's no random effect in this model because date_time is different for each data point... maybe should include date as a random effect somehow?

Issues with model diagnostics (doesn't look a great fit) - random time intercept didn't help but don't fix the issue (caused nonconvergence). Different families seem to help (Beta maybe not best here?)

Same but for forest vs developed: 

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Anth" & Period %in% 'Pre-typhoon' & response_group %in% c('Developed_Var','Forest_Var')) 
dat_post<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Anth" & Period %in% 'Post-typhoon' & response_group %in% c('Developed_Var','Forest_Var'))
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)

# change format of landuse information
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
colnames(df)[4]<-'Landuse'

# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Typhoon * Landuse,
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## typhoon has an effect ##

## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

```

Plot time series of results showing land use x typhoon effects:

```{r}

df<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Anth")
df$response_group[df$response_group %in% 'Total_var']<-'All'
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
df$response_group<-df$response_group %>% parse_character() %>% parse_factor(levels = c('All','Forest','Developed'))

plot1<-df %>% ggplot(aes(x = Date_Time,
                  y = Stability,
                  col = response_group)) +
  scale_colour_manual(values = c('black',"#29a62b","#a629a4")) +
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Trami'][1],lty = 2) + 
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Post-typhoon'][1],lty = 2) + 
  geom_line(show.legend = F) + 
  labs(x = "Time",
       y = "Anthropophony Spatial variability") + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

df2<-df %>% 
  filter(Period %in% c('Pre-typhoon','Post-typhoon')) %>% 
  group_by(response_group,Period) %>% 
  summarise(Med=median(Stability),
            Low=quantile(Stability,probs = 0.05),
            High=quantile(Stability,probs = 0.95))
df2$Period<-df2$Period %>% parse_character() %>% parse_factor(levels = c('Pre-typhoon','Post-typhoon'))


plot2<-df2 %>% ggplot(aes(x = response_group,
                  y = Med,
                  ymin = Low,
                  ymax = High,
                  col = response_group,
                  shape = Period)) +
  scale_colour_manual(values = c('black',"#29a62b","#a629a4")) +
  geom_pointrange(position = position_jitterdodge(),
                  fatten = 5,
                  show.legend = F) + 
  labs(x = "Land use subset",
       y = element_blank()) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

plot1 + plot2 + plot_layout(widths = c(3,1))
```

For axis legend: "dashed lines delineate the pre- and post-typhoon periods."

### Bird detections

## bird detection mean states

**Total detections**

```{r}

dat_pre<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.5 & response_variable %in% 'Pre_mean') 
dat_post<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.5 & response_variable %in% 'Post_mean') 
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)

# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))

# Fit bayesian mixed effects model
mod_nonspatial_negb <- 
  brm(data = df, family = negbinomial(),
      round(Stability) ~ 1 + Landuse + Typhoon + Species_ID + # used round() as poisson needs integers
        Landuse:Typhoon + Landuse:Species_ID + Typhoon:Species_ID + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)

brms::mcmc_plot(mod_nonspatial_negb, type = "trace") + theme_cowplot()
#check for agreement of chains
brms::mcmc_plot(mod_nonspatial_negb, type = "dens_overlay") + theme_cowplot()
# plot posterior probabilities
brms::mcmc_plot(mod_nonspatial_negb, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()
pp_check(mod_nonspatial_negb, ndraws = 500) + theme_cowplot() +  scale_x_continuous(limits = c(0,50))

## plot significant typhoon effect per species
# Corvus #
mut_mod<-mod_nonspatial_negb %>%
  spread_draws(b_TyphoonPost, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_TyphoonPost + r_Site_ID) # get posterior distribution data for plotting
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
} # determine whether credible intervals span zero, and store as binary (to show in plot): 
rm(temp)
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor
corvusplot <- mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","skyblue")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (typhoon effect)",
       y = "Site") + 
  cowplot::theme_minimal_grid()

# Horornis #
mut_mod<-mod_nonspatial_negb %>%
  spread_draws(b_TyphoonPost, `b_TyphoonPost:Species_IDHorornis_diphone`, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_TyphoonPost + `b_TyphoonPost:Species_IDHorornis_diphone` + r_Site_ID) # get posterior distribution data for plotting
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
} # determine whether credible intervals span zero, and store as binary (to show in plot): 
rm(temp) 
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor
horornisplot <- mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","skyblue")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (typhoon effect)",
       y = "") + 
  cowplot::theme_minimal_grid()

# Otus #
mut_mod<-mod_nonspatial_negb %>%
  spread_draws(b_TyphoonPost, `b_TyphoonPost:Species_IDOtus_elegans`, r_Site_ID[Site_ID,]) %>%
  mutate(site_mean = b_TyphoonPost + `b_TyphoonPost:Species_IDOtus_elegans` + r_Site_ID) # get posterior distribution data for plotting
mut_mod$sig<-0
for (i in 1:length(unique(mut_mod$Site_ID))) {
  temp<-mut_mod$site_mean[mut_mod$Site_ID %in% mut_mod$Site_ID[i]] %>% 
    quantile(c(0.05,0.95)) %>% # get 95% credible intervals
    sign() %>% # get sign of those intervals
    duplicated() # are the signs identical (no = zero-spanning)
  if(temp[2] %in% TRUE){ # if signs are identical (non-zero-spanning)
    mut_mod$sig[mut_mod$Site_ID %in% mut_mod$Site_ID[i]]<-1 # add significance indicator
  }
} # determine whether credible intervals span zero, and store as binary (to show in plot): 
rm(temp)
mut_mod$sig<-mut_mod$sig %>% as.character() %>% parse_factor(levels = c('0','1')) # convert to factor
otusplot <-mut_mod %>%
  ggplot(aes(y = Site_ID %>% as.character %>% parse_factor(levels = Site_order), 
             x = site_mean, 
             fill = stat(x) > 0,
             shape = sig)) + 
  stat_halfeye(show.legend = F,slab_type = "pdf") +
  geom_vline(xintercept = 0, 
             linetype = "dashed") +
  scale_fill_manual(values = c("gray80","skyblue")) +
  scale_shape_manual(values = c(21,8)) +
  labs(x = "Posterior draws (typhoon effect)",
       y = "") + 
  cowplot::theme_minimal_grid()

# plots #
plot_grid(corvusplot, horornisplot, otusplot, 
          ncol = 3, align = "hv", 
          labels = c("Corvus", "Horonis", "Otus"))

bayes_R2(mod_nonspatial_negb)

bres <- residuals(mod_nonspatial_negb)[,"Estimate"]
d_mat = as.matrix(dist(df[,c("Lat", "Long")], diag=T, upper=T))
d_mat_inv <- 1/d_mat
d_mat_inv[which(d_mat_inv == Inf)] <- 0
ape::Moran.I(bres, d_mat_inv)

# good fit to data
pp_check(mod_nonspatial_negb, ndraws = 500) + theme_cowplot() +  scale_x_continuous(limits = c(0,50))

```

Why do the posterior draws come from all 24 sites when the different species were only in a subset (17, 11, and 7)???

- Need to fix this. Could explain why the chains are a bit all over the place




Any idea why Otus and Otus x landuse chains go crazy (numbers are insanely high) while everything else looks reasonable?



## bird detection temporal variability

**Total detections**

```{r}

dat_pre<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.5 & response_variable %in% 'Pre_Var') 
dat_post<-tidy.stability_bird %>%
  filter(Cutoff %in% 0.5 & response_variable %in% 'Post_Var') 
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)

# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))

# Fit bayesian mixed effects model
mod_nonspatial_lnorm <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Landuse + Typhoon * Species_ID + (1|Site_ID),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_lnorm <- add_criterion(mod_nonspatial_lnorm, "loo")

#check MCMC traces
brms::mcmc_plot(mod_nonspatial_lnorm, type = "trace") + theme_cowplot()
#check for agreement of chains
brms::mcmc_plot(mod_nonspatial_lnorm, type = "dens_overlay") + theme_cowplot()
# plot posterior probabilities
brms::mcmc_plot(mod_nonspatial_lnorm, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## no significant effects

# good fit to data
pp_check(mod_nonspatial_lnorm, ndraws = 500) + theme_cowplot() +  scale_x_continuous(limits = c(0,10))

```

NB: Beta distribution seems to be a bit better - check data distribution

## bird detection spatial variability

**bird detections**

```{r}

dat_pre<-tidy.spatial_bird %>%
  filter(Period %in% 'Pre-typhoon' & response_group %in% 'Total_Var') 
dat_post<-tidy.spatial_bird %>%
  filter(Period %in% 'Post-typhoon' & response_group %in% 'Total_Var') 
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)

# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))

mod_nonspatial_lnorm <- 
  brm(data = df, family = lognormal(),
      Stability ~ 1 + Typhoon * Species + (1|Species),
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_lnorm <- add_criterion(mod_nonspatial_lnorm, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_lnorm, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_lnorm, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_lnorm, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## typhoon has an effect ##

## Parameter fits and stats 

mod_nonspatial_lnorm$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_lnorm) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_lnorm, ndraws = 500) + theme_cowplot()

```

NB: there's no random effect in this model because date_time is different for each data point... maybe should include date as a random effect somehow?

Issues with model diagnostics (doesn't look a great fit) - random time intercept didn't help but don't fix the issue (caused nonconvergence). Different families seem to help (Beta maybe not best here?)

Same but for forest vs developed: 

```{r}

# get pre vs post data for comparison
dat_pre<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Anth" & Period %in% 'Pre-typhoon' & response_group %in% c('Developed_Var','Forest_Var')) 
dat_post<-tidy.spatial_AI %>%
  filter(Index %in% "NDSI_Anth" & Period %in% 'Post-typhoon' & response_group %in% c('Developed_Var','Forest_Var'))
dat_pre<-dat_pre[complete.cases(dat_pre),]
dat_post<-dat_post[complete.cases(dat_post),]
dat_pre$Typhoon = rep("Pre", nrow(dat_pre))
dat_post$Typhoon = rep("Post", nrow(dat_post))
df <- rbind(dat_pre, dat_post)

# change format of landuse information
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
colnames(df)[4]<-'Landuse'

# change levels for model
df$Typhoon<-df$Typhoon %>% parse_character() %>% parse_factor(levels = c('Pre','Post'))
df$Landuse<-df$Landuse %>% parse_character() %>% parse_factor(levels = c('Forest','Developed'))

mod_nonspatial_beta <- 
  brm(data = df, family = Beta(),
      Stability ~ 1 + Typhoon * Landuse,
      iter = 5e4, warmup = 5000, chains = 4, cores = 4, thin = 2,
      seed = 666)
mod_nonspatial_beta <- add_criterion(mod_nonspatial_beta, "loo")

#check MCMC traces
mcmc_plot(mod_nonspatial_beta, type = "trace") + theme_cowplot()
#check for agreement of chains
mcmc_plot(mod_nonspatial_beta, type = "dens_overlay") + theme_cowplot()
# plot posterior estimates of fixed effects
mcmc_plot(mod_nonspatial_beta, type = "intervals",prob = 0.68, prob_outer = 0.95, variable = "^b_", regex = TRUE) + theme_cowplot()

## typhoon has an effect ##

## Parameter fits and stats 

mod_nonspatial_beta$fit # Rhat values closer to 1 and n_eff values > 1000 are ideal.
bayes_R2(mod_nonspatial_beta) # pseudo r-squared of model
# simulate data from 500 random draws of posterior and compare it to observed data
# the black line should run through the center of the blue lines
pp_check(mod_nonspatial_beta, ndraws = 500) + theme_cowplot()

```

Plot time series of results showing land use x typhoon effects:

```{r}

df<-tidy.spatial_bird
df$response_group[df$response_group %in% 'Total_var']<-'All'
df$response_group[df$response_group %in% 'Forest_Var']<-'Forest'
df$response_group[df$response_group %in% 'Developed_Var']<-'Developed'
df$response_group<-df$response_group %>% parse_character() %>% parse_factor(levels = c('All','Forest','Developed'))

plot1<-df %>% ggplot(aes(x = Date,
                  y = Stability,
                  col = response_group)) +
  scale_colour_manual(values = c('black',"#29a62b","#a629a4")) +
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Trami'][1],lty = 2) + 
  geom_vline(xintercept = df$Date_Time[df$Period %in% 'Post-typhoon'][1],lty = 2) + 
  geom_line(show.legend = F) + 
  labs(x = "Time",
       y = "Anthropophony Spatial variability") + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

df2<-df %>% 
  filter(Period %in% c('Pre-typhoon','Post-typhoon')) %>% 
  group_by(response_group,Period) %>% 
  summarise(Med=median(Stability),
            Low=quantile(Stability,probs = 0.05,na.rm=T),
            High=quantile(Stability,probs = 0.95,na.rm=T))
df2$Period<-df2$Period %>% parse_character() %>% parse_factor(levels = c('Pre-typhoon','Post-typhoon'))


plot2<-df2 %>% ggplot(aes(x = response_group,
                  y = Med,
                  ymin = Low,
                  ymax = High,
                  col = response_group,
                  shape = Period)) +
  scale_colour_manual(values = c('black',"#29a62b","#a629a4")) +
  geom_pointrange(position = position_jitterdodge(),
                  fatten = 5,
                  show.legend = F) + 
  labs(x = "Land use subset",
       y = element_blank()) + 
  theme_cowplot(12) + 
  ylim(c(df$Stability %>% min(),
         df$Stability %>% max()))

plot1 + plot2 + plot_layout(widths = c(3,1))
```





BIRDS VAR

BIRDS SPATIAL VAR


### Figure S2

Finally, we'll compare the different automatic filtering thresholds for species detection confidence. We'll filter the dataset by only those sites where we have detections for all 3 species (N = 7). 

```{r}

# subset dataframe
ext_chng_all<-tidy.stability_bird %>%
  filter(Stability_dimension %in% 'Ext_Chng') 

ext_chng_all<-ext_chng_all %>% 
  group_by(Site_ID) %>% 
  filter(length(Stability_dimension) == 9)

# convert to factor
ext_chng_all$Site_ID<-ext_chng_all$Site_ID %>% parse_character() %>% parse_factor(ordered = T)
ext_chng_all$Species_ID<-ext_chng_all$Species_ID %>% parse_character() %>% parse_factor(levels = c('Corvus_macrorhynchos','Horornis_diphone','Otus_elegans'))
ext_chng_all$Cutoff<-ext_chng_all$Cutoff %>% as.character() %>% parse_factor(ordered = T)
ext_chng_all$p_sig<-ext_chng_all$p_sig %>% as.character() %>% parse_factor(levels = c('0','1'))

```
