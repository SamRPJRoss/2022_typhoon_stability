---
title: "Additional figures"
author: "Samuel R.P-J. Ross"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

load(here("Data/Acoustic_Indices.rda"))
load(here("Data/2022_Species_Detections.rda"))

## Function for calculating two dimensions of response diversity
resp_div <- function(x, sign_sens = TRUE) {
  
  flag <- TRUE # flag to catch if all values are the same
  
  ## set diversity to zero if all values are the same
  if(length(unique(x)) == 1) {
    div = 0
    flag <- FALSE
  }
  
  ## keep going only if all values are not the same
  if(flag) {
    
    ## stat == range
    if(!sign_sens) {
        
        d <- dist(x, diag = T) # euclidean distance matrix
        Z <- exp(as.matrix(-d)) # similarity matrix
        nspecies <- length(x)
        p=matrix(1/nspecies,nspecies) # relative abundance matrix. Needs to be changed if evenness is of interest
        lenq = 1 # initialises hill number. Need to fix if we want any evenness indices
        qq <- seq(length=lenq, from=0, by=.11)
        
        # Initialise the Zp matrix to zero
        Zp=matrix(0,nspecies,1)
        
        # Compute Zp
        for (i in 1:nspecies){
          for (j in 1:nspecies){
            Zp[i,1]<-Zp[i,1]+Z[i,j]*p[j,1]
          }
        }
        
        # Initialise the Diversity matrix to zero
        Dqz = matrix(0, lenq ,1)
        
        for (iq in 1:lenq)  {
          q<-qq[iq];
          for (zpi in 1:length(Zp[,1])){
            if (Zp[zpi,1]>0)(
              Dqz[iq,1]<-Dqz[iq,1]+ p[zpi,1]*(Zp[zpi,1])^(q-1))
          }
          
          Dqz[iq,1] <- Dqz[iq,1]^(1/(1-q));
        }
        div <- Dqz[iq,1]
    }
        
      }
      
      if(sign_sens) {
        div1 <- max(x) - min(x)
        div2 <- abs(abs(max(x)) - abs(min(x)))
        div <- (div1 - div2) / div1
    }
  
  names(div) <- paste(sign_sens)
  
  div
  
}
```

This document is for making the additional Figures and analyses asked for by Reviewers during the review process. 

**Note: must run Measure_stability.Rmd and Analyse_results.Rmd first.**

# Pre-disturbance soundscapes

First, make time series to characterise pre-typhoon soundscapes in each site, separated by forest vs developed sites and acoustic index.

```{r}

# filter and add land use
Plot_dat1<-Standardised_AIs %>% filter(Period == "Pre-typhoon")
Plot_dat1$Landuse[Plot_dat1$Site_ID %in% Sites_Forest]<-'Forest'
Plot_dat1$Landuse[Plot_dat1$Site_ID %in% Sites_Developed]<-'Developed'
Plot_dat1$Landuse<-Plot_dat1$Landuse %>% factor(levels = c('Forest','Developed'))

# Aggregate to daily for easy plotting
Mean_out<-aggregate(NDSI ~ Site_ID*Date, data = Plot_dat1, FUN = mean)
Mean_out$Landuse[Mean_out$Site_ID %in% Sites_Forest]<-'Forest'
Mean_out$Landuse[Mean_out$Site_ID %in% Sites_Developed]<-'Developed'
Mean_out$Landuse<-Mean_out$Landuse %>% factor(levels = c('Forest','Developed'))

Mean_out2<-aggregate(NDSI_Bio ~ Site_ID*Date, data = Plot_dat1, FUN = mean)
Mean_out2$Landuse[Mean_out2$Site_ID %in% Sites_Forest]<-'Forest'
Mean_out2$Landuse[Mean_out2$Site_ID %in% Sites_Developed]<-'Developed'
Mean_out2$Landuse<-Mean_out2$Landuse %>% factor(levels = c('Forest','Developed'))

Mean_out3<-aggregate(NDSI_Anth ~ Site_ID*Date, data = Plot_dat1, FUN = mean)
Mean_out3$Landuse[Mean_out3$Site_ID %in% Sites_Forest]<-'Forest'
Mean_out3$Landuse[Mean_out3$Site_ID %in% Sites_Developed]<-'Developed'
Mean_out3$Landuse<-Mean_out3$Landuse %>% factor(levels = c('Forest','Developed'))

# plot all sites separated by landuse
Panel_a<-Mean_out %>% ggplot(aes(x = Date,
                  y = NDSI,
                  col = Landuse, 
                  group = Site_ID)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_line(show.legend = F,alpha = 0.4) + 
  labs(x = "Date (pre-typhoon)",
       y = "Mean Daily NDSI") + 
  theme_cowplot(12) +
  facet_grid(. ~ Landuse)

Panel_b<-Mean_out2 %>% ggplot(aes(x = Date,
                  y = NDSI_Bio,
                  col = Landuse, 
                  group = Site_ID)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_line(show.legend = F,alpha = 0.4) + 
  labs(x = "Date (pre-typhoon)",
       y = "Mean Daily Biophony (NDSI_Bio)") + 
  theme_cowplot(12) +
  facet_grid(. ~ Landuse)

Panel_c<-Mean_out3 %>% ggplot(aes(x = Date,
                  y = NDSI_Anth,
                  col = Landuse, 
                  group = Site_ID)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_line(show.legend = F,alpha = 0.4) + 
  labs(x = "Date (pre-typhoon)",
       y = "Mean Daily Anthropophony (NDSI_Anthro)") + 
  theme_cowplot(12) +
  facet_grid(. ~ Landuse)
```

Plot as multi-panel:
```{r}
Panel_a/Panel_b/Panel_c
```

# Dawn Chorus

Next, we'll aim to show that sampling just the dawn chorus isn't a big improvement on sampling the whole day. To do this we'll take daily averages and compare them to averages at only dawn per day. 

```{r}

library(dplyr)
library(lubridate)

Plot_dat1$Time <- as.POSIXct(Plot_dat1$Date_Time, format = "%Y-%m-%d %H:%M:%S")
# isolate dawn period (sunrise around 6am, so take 5-7 as dawn chorus)
Dawn<-Plot_dat1 %>% 
  filter(hour(Time) >= 5, 
         hour(Time) <= 6)
  
# get means of dawn chorus per day - NDSI
Dawn_out<-semi_join(Mean_out, Dawn, 
                    by = c("Site_ID", "Date"))
Dawn_out$Dawn<-aggregate(NDSI ~ Site_ID*Date, data = Dawn, FUN = mean)[,3]

# get means of dawn chorus per day - NDSI_Bio
Dawn_out2<-semi_join(Mean_out2, Dawn, 
                    by = c("Site_ID", "Date"))
Dawn_out2$Dawn<-aggregate(NDSI_Bio ~ Site_ID*Date, data = Dawn, FUN = mean)[,3]

# get means of dawn chorus per day - NDSI_Anth
Dawn_out3<-semi_join(Mean_out3, Dawn, 
                    by = c("Site_ID", "Date"))
Dawn_out3$Dawn<-aggregate(NDSI_Anth ~ Site_ID*Date, data = Dawn, FUN = mean)[,3]

```

Now plot the correlation between daily means and dawn chorus means: 

```{r}

Panel_a<-Dawn_out %>% ggplot(aes(x = Dawn,
                  y = NDSI,
                  col = Landuse, 
                  group = Site_ID)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_point(show.legend = F,alpha = 0.4) + 
  geom_smooth(se = F,method = "lm",show.legend = F) +
  labs(x = "Mean Daily NDSI (Dawn)",
       y = "Mean Daily NDSI") + 
  theme_cowplot(12) +
  facet_grid(. ~ Landuse)

Panel_b<-Dawn_out2 %>% ggplot(aes(x = Dawn,
                  y = NDSI_Bio,
                  col = Landuse, 
                  group = Site_ID)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_point(show.legend = F,alpha = 0.4) + 
  geom_smooth(se = F,method = "lm",show.legend = F) +
  labs(x = "Mean Daily NDSI_Bio (Dawn)",
       y = "Mean Daily NDSI_Bio") + 
  theme_cowplot(12) +
  facet_grid(. ~ Landuse)

Panel_c<-Dawn_out3 %>% ggplot(aes(x = Dawn,
                  y = NDSI_Anth,
                  col = Landuse, 
                  group = Site_ID)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_point(show.legend = F,alpha = 0.4) + 
  geom_smooth(se = F,method = "lm",show.legend = F) +
  labs(x = "Mean Daily NDSI_Anthro (Dawn)",
       y = "Mean Daily NDSI_Anthro") + 
  theme_cowplot(12) +
  facet_grid(. ~ Landuse)

```

Plot as multi-panel:
```{r}
Panel_a/Panel_b/Panel_c
```

# Response pathways

Next, make a figure showing the variation in possible response pathways. We can do this by taking the derivatives of the time series to show how acoustic index values change over time. 

```{r}

# get data and add land use
Plot_dat2<-Standardised_AIs
Plot_dat2$Landuse[Plot_dat2$Site_ID %in% Sites_Forest]<-'Forest'
Plot_dat2$Landuse[Plot_dat2$Site_ID %in% Sites_Developed]<-'Developed'
Plot_dat2$Landuse<-Plot_dat2$Landuse %>% factor(levels = c('Forest','Developed'))
Plot_dat2$Date<-as.numeric(Plot_dat2$Date)
Plot_dat2$Date<-Plot_dat2$Date-(min(Plot_dat2$Date)-1)

# Aggregate to daily for easy plotting
Mean_out<-aggregate(NDSI ~ Site_ID*Date, data = Plot_dat2, FUN = mean)
Mean_out$Landuse[Mean_out$Site_ID %in% Sites_Forest]<-'Forest'
Mean_out$Landuse[Mean_out$Site_ID %in% Sites_Developed]<-'Developed'
Mean_out$Landuse<-Mean_out$Landuse %>% factor(levels = c('Forest','Developed'))

Mean_out2<-aggregate(NDSI_Bio ~ Site_ID*Date, data = Plot_dat2, FUN = mean)
Mean_out2$Landuse[Mean_out2$Site_ID %in% Sites_Forest]<-'Forest'
Mean_out2$Landuse[Mean_out2$Site_ID %in% Sites_Developed]<-'Developed'
Mean_out2$Landuse<-Mean_out2$Landuse %>% factor(levels = c('Forest','Developed'))

Mean_out3<-aggregate(NDSI_Anth ~ Site_ID*Date, data = Plot_dat2, FUN = mean)
Mean_out3$Landuse[Mean_out3$Site_ID %in% Sites_Forest]<-'Forest'
Mean_out3$Landuse[Mean_out3$Site_ID %in% Sites_Developed]<-'Developed'
Mean_out3$Landuse<-Mean_out3$Landuse %>% factor(levels = c('Forest','Developed'))

```

First model daily values as a function of time:

```{r}

library(mgcv)

# Create a list to store the GAM models and data for each site
gam_data_list <- list()

# Get unique Site_ID values
site_ids <- unique(Mean_out$Site_ID)

# Loop through each site and fit a GAM model
for (site_id in site_ids) {
  
  # Subset the data for the current site
  site_data <- Mean_out[Mean_out$Site_ID == site_id, ]
  
  # Fit the GAM model for the current site
  gam_model <- gam(NDSI ~ s(Date), data = site_data)
  
  # Store the GAM model and data in the list
  gam_data_list[[site_id]] <- list(model = gam_model, data = site_data)
}

```

Then we calculate the first derivatives of these relationships.

```{r}

library(gratia)

# Create a list to store the derivatives for each site
derivatives_list <- list()

# Loop through each site in gam_data_list
for (site_id in names(gam_data_list)) {
  
  # Get the GAM model for the current site
  gam_model <- gam_data_list[[site_id]]$model
  
  # Calculate the derivatives
  derivatives <- derivatives(gam_model, which = "s(Date)")
  
  # Store the derivatives in the list
  derivatives_list[[site_id]] <- derivatives
}

# store site names
names(derivatives_list)<-site_ids

# unlist into a single dataframe
derivatives_df <- bind_rows(derivatives_list, .id = "Site_ID")

# add land use
derivatives_df$Landuse[derivatives_df$Site_ID %in% Sites_Forest]<-'Forest'
derivatives_df$Landuse[derivatives_df$Site_ID %in% Sites_Developed]<-'Developed'
derivatives_df$Landuse<-derivatives_df$Landuse %>% factor(levels = c('Forest','Developed'))

```

Plot results for NDSI:

```{r}

Panel_a<-derivatives_df %>% ggplot(mapping = aes(x = data,
                                        y = derivative,
                                        group = Site_ID,
                                        col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = 30,lty = 2) +
  geom_vline(xintercept = 37,lty = 2) +
  geom_hline(yintercept = 0,lty = 3) +
  geom_line(alpha = 0.4,show.legend = F) +
  labs(x = "Date",
       y = "Derivative (NDSI)") + 
  theme_cowplot(12) +
  facet_grid(. ~ Landuse)

```

Now the same for NDSI_Bio:

```{r}

# Create a list to store the GAM models and data for each site
gam_data_list <- list()

# Get unique Site_ID values
site_ids <- unique(Mean_out2$Site_ID)

# Loop through each site and fit a GAM model
for (site_id in site_ids) {
  
  # Subset the data for the current site
  site_data <- Mean_out2[Mean_out2$Site_ID == site_id, ]
  
  # Fit the GAM model for the current site
  gam_model <- gam(NDSI_Bio ~ s(Date), data = site_data)
  
  # Store the GAM model and data in the list
  gam_data_list[[site_id]] <- list(model = gam_model, data = site_data)
}

# Create a list to store the derivatives for each site
derivatives_list <- list()

# Loop through each site in gam_data_list
for (site_id in names(gam_data_list)) {
  
  # Get the GAM model for the current site
  gam_model <- gam_data_list[[site_id]]$model
  
  # Calculate the derivatives
  derivatives <- derivatives(gam_model, which = "s(Date)")
  
  # Store the derivatives in the list
  derivatives_list[[site_id]] <- derivatives
}

# store site names
names(derivatives_list)<-site_ids

# unlist into a single dataframe
derivatives_df2 <- bind_rows(derivatives_list, .id = "Site_ID")

# add land use
derivatives_df2$Landuse[derivatives_df2$Site_ID %in% Sites_Forest]<-'Forest'
derivatives_df2$Landuse[derivatives_df2$Site_ID %in% Sites_Developed]<-'Developed'
derivatives_df2$Landuse<-derivatives_df2$Landuse %>% factor(levels = c('Forest','Developed'))

```

```{r}

Panel_b<-derivatives_df2 %>% ggplot(mapping = aes(x = data,
                                        y = derivative,
                                        group = Site_ID,
                                        col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = 30,lty = 2) +
  geom_vline(xintercept = 37,lty = 2) +
  geom_hline(yintercept = 0,lty = 3) +
  geom_line(alpha = 0.4,show.legend = F) +
  labs(x = "Date",
       y = "Derivative (NDSI_Bio)") + 
  theme_cowplot(12) +
  facet_grid(. ~ Landuse)

```

Now the same for NDSI_Anthro:

```{r}

# Create a list to store the GAM models and data for each site
gam_data_list <- list()

# Get unique Site_ID values
site_ids <- unique(Mean_out3$Site_ID)

# Loop through each site and fit a GAM model
for (site_id in site_ids) {
  
  # Subset the data for the current site
  site_data <- Mean_out3[Mean_out3$Site_ID == site_id, ]
  
  # Fit the GAM model for the current site
  gam_model <- gam(NDSI_Anth ~ s(Date), data = site_data)
  
  # Store the GAM model and data in the list
  gam_data_list[[site_id]] <- list(model = gam_model, data = site_data)
}

# Create a list to store the derivatives for each site
derivatives_list <- list()

# Loop through each site in gam_data_list
for (site_id in names(gam_data_list)) {
  
  # Get the GAM model for the current site
  gam_model <- gam_data_list[[site_id]]$model
  
  # Calculate the derivatives
  derivatives <- derivatives(gam_model, which = "s(Date)")
  
  # Store the derivatives in the list
  derivatives_list[[site_id]] <- derivatives
}

# store site names
names(derivatives_list)<-site_ids

# unlist into a single dataframe
derivatives_df3 <- bind_rows(derivatives_list, .id = "Site_ID")

# add land use
derivatives_df3$Landuse[derivatives_df3$Site_ID %in% Sites_Forest]<-'Forest'
derivatives_df3$Landuse[derivatives_df3$Site_ID %in% Sites_Developed]<-'Developed'
derivatives_df3$Landuse<-derivatives_df3$Landuse %>% factor(levels = c('Forest','Developed'))

```

```{r}

Panel_c<-derivatives_df3 %>% ggplot(mapping = aes(x = data,
                                        y = derivative,
                                        group = Site_ID,
                                        col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = 30,lty = 2) +
  geom_vline(xintercept = 37,lty = 2) +
  geom_hline(yintercept = 0,lty = 3) +
  geom_line(alpha = 0.4,show.legend = F) +
  labs(x = "Date",
       y = "Derivative (NDSI_Anthro)") + 
  theme_cowplot(12) +
  facet_grid(. ~ Landuse)

```

Plot as multi-panel:
```{r}
Panel_a/Panel_b/Panel_c
```

Also measure Response Diversity using 2 metrics in Ross et al. (2023, Methods Ecol. Evol.) for each time point separated by land use:

```{r}

## calculate the diversity metrics - NDSI
summary_stats <- derivatives_df %>%
  group_by(Landuse, data) %>%
  summarise(dissimilarity = resp_div(derivative,sign_sens = FALSE),
            divergence = resp_div(derivative,sign_sens = TRUE)) 
summary_stats<-summary_stats[complete.cases(summary_stats),] # remove incomplete cases
colnames(summary_stats)[2]<-"Time"

## calculate the diversity metrics - NDSI_Bio
summary_stats2 <- derivatives_df2 %>%
  group_by(Landuse, data) %>%
  summarise(dissimilarity = resp_div(derivative,sign_sens = FALSE),
            divergence = resp_div(derivative,sign_sens = TRUE)) 
summary_stats2<-summary_stats2[complete.cases(summary_stats2),] # remove incomplete cases
colnames(summary_stats2)[2]<-"Time"

## calculate the diversity metrics - NDSI_Anthro
summary_stats3 <- derivatives_df3 %>%
  group_by(Landuse, data) %>%
  summarise(dissimilarity = resp_div(derivative,sign_sens = FALSE),
            divergence = resp_div(derivative,sign_sens = TRUE)) 
summary_stats3<-summary_stats3[complete.cases(summary_stats3),] # remove incomplete cases
colnames(summary_stats3)[2]<-"Time"
```

Plot response diversity time series: 

```{r}

Panel_a<-summary_stats %>% ggplot(mapping = aes(x = Time,
                                        y = dissimilarity,
                                        group = Landuse,
                                        col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = 30,lty = 2) +
  geom_vline(xintercept = 37,lty = 2) +
  geom_line(alpha = 0.8,show.legend = F) +
  labs(x = "Date",
       y = "Dissimilarity (NDSI)") + 
  theme_cowplot(12)

Panel_b<-summary_stats %>% ggplot(mapping = aes(x = Time,
                                        y = divergence,
                                        group = Landuse,
                                        col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = 30,lty = 2) +
  geom_vline(xintercept = 37,lty = 2) +
  geom_line(alpha = 0.8,show.legend = F) +
  labs(x = "Date",
       y = "Divergence (NDSI)") + 
  theme_cowplot(12)

Panel_c<-summary_stats2 %>% ggplot(mapping = aes(x = Time,
                                        y = dissimilarity,
                                        group = Landuse,
                                        col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = 30,lty = 2) +
  geom_vline(xintercept = 37,lty = 2) +
  geom_line(alpha = 0.8,show.legend = F) +
  labs(x = "Date",
       y = "Dissimilarity (NDSI_Bio)") + 
  theme_cowplot(12)

Panel_d<-summary_stats2 %>% ggplot(mapping = aes(x = Time,
                                        y = divergence,
                                        group = Landuse,
                                        col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = 30,lty = 2) +
  geom_vline(xintercept = 37,lty = 2) +
  geom_line(alpha = 0.8,show.legend = F) +
  labs(x = "Date",
       y = "Divergence (NDSI_Bio)") + 
  theme_cowplot(12)

Panel_e<-summary_stats3 %>% ggplot(mapping = aes(x = Time,
                                        y = dissimilarity,
                                        group = Landuse,
                                        col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = 30,lty = 2) +
  geom_vline(xintercept = 37,lty = 2) +
  geom_line(alpha = 0.8,show.legend = F) +
  labs(x = "Date",
       y = "Dissimilarity (NDSI_Anthro)") + 
  theme_cowplot(12)

Panel_f<-summary_stats3 %>% ggplot(mapping = aes(x = Time,
                                        y = divergence,
                                        group = Landuse,
                                        col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = 30,lty = 2) +
  geom_vline(xintercept = 37,lty = 2) +
  geom_line(alpha = 0.8,show.legend = F) +
  labs(x = "Date",
       y = "Divergence (NDSI_Anthro)") + 
  theme_cowplot(12)

```


```{r}
(Panel_a+Panel_b)/(Panel_c+Panel_d)/(Panel_e+Panel_f)
```

Plot boxplot summaries of post-typhoon response diversity:

```{r}
# subset to only post-typhoon period
summary_stats<-summary_stats %>% subset(summary_stats$Time >= 37)
summary_stats2<-summary_stats2 %>% subset(summary_stats2$Time >= 37)
summary_stats3<-summary_stats3 %>% subset(summary_stats3$Time >= 37)

# plot boxplots of response diversity values
Panel_a<-summary_stats %>% ggplot(mapping = aes(x = Landuse,
                                       y = dissimilarity,
                                    fill = Landuse)) +
  scale_fill_manual(values = c("#29a62b","#a629a4")) +
  geom_jitter(alpha = 0.4,show.legend = F) + 
  geom_boxplot(alpha = 0.4,show.legend = F) +
  labs(x = "Land use",
       y = "Post-typhoon Dissimilarity (NDSI)") + 
  theme_cowplot(12)

Panel_b<-summary_stats %>% ggplot(mapping = aes(x = Landuse,
                                       y = divergence,
                                    fill = Landuse)) +
  scale_fill_manual(values = c("#29a62b","#a629a4")) +
  geom_jitter(alpha = 0.4,show.legend = F) + 
  geom_boxplot(alpha = 0.4,show.legend = F) +
  labs(x = "Land use",
       y = "Post-typhoon Divergence (NDSI)") + 
  theme_cowplot(12)

Panel_c<-summary_stats2 %>% ggplot(mapping = aes(x = Landuse,
                                       y = dissimilarity,
                                    fill = Landuse)) +
  scale_fill_manual(values = c("#29a62b","#a629a4")) +
  geom_jitter(alpha = 0.4,show.legend = F) + 
  geom_boxplot(alpha = 0.4,show.legend = F) +
  labs(x = "Land use",
       y = "Post-typhoon Dissimilarity (NDSI_Bio)") + 
  theme_cowplot(12)

Panel_d<-summary_stats2 %>% ggplot(mapping = aes(x = Landuse,
                                       y = divergence,
                                    fill = Landuse)) +
  scale_fill_manual(values = c("#29a62b","#a629a4")) +
  geom_jitter(alpha = 0.4,show.legend = F) + 
  geom_boxplot(alpha = 0.4,show.legend = F) +
  labs(x = "Land use",
       y = "Post-typhoon Divergence (NDSI_Bio)") + 
  theme_cowplot(12)

Panel_e<-summary_stats3 %>% ggplot(mapping = aes(x = Landuse,
                                       y = dissimilarity,
                                    fill = Landuse)) +
  scale_fill_manual(values = c("#29a62b","#a629a4")) +
  geom_jitter(alpha = 0.4,show.legend = F) + 
  geom_boxplot(alpha = 0.4,show.legend = F) +
  labs(x = "Land use",
       y = "Post-typhoon Dissimilarity (NDSI_Anthro)") + 
  theme_cowplot(12)

Panel_f<-summary_stats3 %>% ggplot(mapping = aes(x = Landuse,
                                       y = divergence,
                                    fill = Landuse)) +
  scale_fill_manual(values = c("#29a62b","#a629a4")) +
  geom_jitter(alpha = 0.4,show.legend = F) + 
  geom_boxplot(alpha = 0.4,show.legend = F) +
  labs(x = "Land use",
       y = "Post-typhoon Divergence (NDSI_Anthro)") + 
  theme_cowplot(12)
```

```{r}
(Panel_a+Panel_b)/(Panel_c+Panel_d)/(Panel_e+Panel_f)
```



To put this into context, get the mean derivative values after the typhoons and compare between forest and developed sites: 

```{r}

# subset to only post-typhoon period
derivatives_df<-derivatives_df %>% subset(derivatives_df$data >= 37)
derivatives_df2<-derivatives_df2 %>% subset(derivatives_df2$data >= 37)
derivatives_df3<-derivatives_df3 %>% subset(derivatives_df3$data >= 37)

# get mean values of derivatives per site
Mean_deriv<-aggregate(derivative ~ Site_ID, data = derivatives_df, FUN = mean)
Mean_deriv$Landuse[Mean_deriv$Site_ID %in% Sites_Forest]<-'Forest'
Mean_deriv$Landuse[Mean_deriv$Site_ID %in% Sites_Developed]<-'Developed'
Mean_deriv$Landuse<-Mean_deriv$Landuse %>% factor(levels = c('Forest','Developed'))

Mean_deriv2<-aggregate(derivative ~ Site_ID, data = derivatives_df2, FUN = mean)
Mean_deriv2$Landuse[Mean_deriv2$Site_ID %in% Sites_Forest]<-'Forest'
Mean_deriv2$Landuse[Mean_deriv2$Site_ID %in% Sites_Developed]<-'Developed'
Mean_deriv2$Landuse<-Mean_deriv2$Landuse %>% factor(levels = c('Forest','Developed'))

Mean_deriv3<-aggregate(derivative ~ Site_ID, data = derivatives_df3, FUN = mean)
Mean_deriv3$Landuse[Mean_deriv3$Site_ID %in% Sites_Forest]<-'Forest'
Mean_deriv3$Landuse[Mean_deriv3$Site_ID %in% Sites_Developed]<-'Developed'
Mean_deriv3$Landuse<-Mean_deriv3$Landuse %>% factor(levels = c('Forest','Developed'))

```

Plot as boxplots:

```{r}

Panel_a<-Mean_deriv %>% ggplot(mapping = aes(x = Landuse,
                                        y = derivative,
                                    fill = Landuse)) +
  scale_fill_manual(values = c("#29a62b","#a629a4")) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_jitter(alpha = 0.4,show.legend = F) + 
  geom_boxplot(alpha = 0.4,show.legend = F) +
  labs(x = "Land use",
       y = "Mean Post-typhoon Derivative (NDSI)") + 
  theme_cowplot(12)

Panel_b<-Mean_deriv2 %>% ggplot(mapping = aes(x = Landuse,
                                        y = derivative,
                                    fill = Landuse)) +
  scale_fill_manual(values = c("#29a62b","#a629a4")) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_jitter(alpha = 0.4,show.legend = F) + 
  geom_boxplot(alpha = 0.4,show.legend = F) +
  labs(x = "Land use",
       y = "Mean Post-typhoon Derivative (NDSI_Bio)") + 
  theme_cowplot(12)

Panel_c<-Mean_deriv3 %>% ggplot(mapping = aes(x = Landuse,
                                        y = derivative,
                                    fill = Landuse)) +
  scale_fill_manual(values = c("#29a62b","#a629a4")) +
  geom_hline(yintercept = 0, lty = 2) +
  geom_jitter(alpha = 0.4,show.legend = F) + 
  geom_boxplot(alpha = 0.4,show.legend = F) +
  labs(x = "Land use",
       y = "Mean Post-typhoon Derivative (NDSI_Anthro)") + 
  theme_cowplot(12)
```

Plot as multi-panel:
```{r}
Panel_a/Panel_b/Panel_c
```

# H. diphone declines

Here, we aim to show the declines of H. diphone as time series, so as to potentially better demonstrate that these declines aren't likely caused by seasonality. 

```{r}
# generate dataframe
Daily_species<-data.frame('Site_ID'=rep(unique(Species_detections$Site_ID), # repeat sites
                                        each=67*3), # 67 days x 3 species
                          'Species_ID'=rep(rep(unique(Species_detections$Species_ID),each=67),22),
                          'Date' = rep(seq(as.Date(min(unique(Species_detections$Date))),
                                           as.Date(max(unique(Species_detections$Date))),"days"),
                                       22*3), # 22 sites x 3 species
                          'Detect.Num' = NA, 'Cutoff' = NA, 'Period' = NA)

Daily_species<-Daily_species %>% typhoon.period() # get typhoon periods

Daily_species<-rbind(Daily_species,Daily_species,Daily_species)
Daily_species$Cutoff<-c(0.5,0.75,0.9) %>% rep(each = Daily_species %>% nrow()/3) # get cutoff values

## subset to 0.5 cutoff and H. diphone only
Daily_Horornis<-Daily_species %>% subset(Species_ID %in% 'Horornis_diphone' &
                         Cutoff == 0.5)

# get daily detections
for (i in 1:length(Daily_Horornis$Site_ID)) {
  Daily_Horornis$Detect.Num[i]<-Species_detections$Filename[Species_detections$Site_ID %in% Daily_Horornis$Site_ID[i] & 
                                                           Species_detections$Species_ID %in% Daily_Horornis$Species_ID[i] & 
                                                           Species_detections$Date %in% Daily_Horornis$Date[i] & 
                                                           Species_detections$Cluster_dist <= Daily_Horornis$Cutoff[i]] %>% length()
}
rm(i)

# add landuse for plotting
Daily_Horornis$Landuse[Daily_Horornis$Site_ID %in% Sites_Forest]<-'Forest'
Daily_Horornis$Landuse[Daily_Horornis$Site_ID %in% Sites_Developed]<-'Developed'
Daily_Horornis$Landuse<-Daily_Horornis$Landuse %>% factor(levels = c('Forest','Developed'))

```

Plot time series of detections as above: 

```{r}
Daily_Horornis %>% ggplot(mapping = aes(x = Date,
                                        y = Detect.Num,
                                        group = Site_ID,
                                        col = Landuse)) +
  scale_colour_manual(values = c("#29a62b","#a629a4")) +
  geom_vline(xintercept = Daily_Horornis$Date[Daily_Horornis$Period %in% "Trami"][1],lty = 4) +
  geom_vline(xintercept = Daily_Horornis$Date[Daily_Horornis$Period %in% "Kong-Rey"][1],lty = 4) +
  geom_line(alpha = 0.4,show.legend = F) +
  labs(x = "Date",
       y = "Daily H. diphone detections") + 
  theme_cowplot(12) +
  facet_grid(. ~ Landuse)
```

We see that when the typhoons hit there is a very direct decline in species vocalisation detections. 
